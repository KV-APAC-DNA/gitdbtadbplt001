with source as (
    select * from {{ ref('aspitg_integration__itg_invc_sls') }}
),
edw_calendar_dim as (
select * from {{ ref('aspedw_integration__edw_calendar_dim') }} 
),
final as(
  SELECT
    trim(act_delv_dt) as act_delv_dt,
    trim(act_good_iss_dt) as act_good_iss_dt,
    trim(bill_to_prty) as bill_to_prty,
    trim(bill_dt) as bill_dt,
    trim(bill_ty) as bill_ty,
    trim(bill_doc) as bill_doc,
    trim(cmpy_cd) as cmpy_cd,
    trim(cust_no) as cust_no,
    trim(delv_doc_crt_dt) as delv_doc_crt_dt,
    trim(dstr_chnl) as dstr_chnl,
    trim(div) as div,
    trim(doc_crt_dt) as doc_crt_dt,
    trim(doc_dt) as doc_dt,
    trim(good_iss_dt) as good_iss_dt,
    trim(mat) as mat,
    trim(mat_avail_dt) as mat_avail_dt,
    trim(ord_rsn) as ord_rsn,
    trim(ovrl_rej_sts) as ovrl_rej_sts,
    trim(ovrl_sts_crd_chk) as ovrl_sts_crd_chk,
    trim(payer) as payer,
    trim(plant) as plant,
    trim(prec_doc_itm) as prec_doc_itm,
    trim(prec_doc_num) as prec_doc_num,
    trim(proof_delv_dt) as proof_delv_dt,
    trim(rsn_cd_key) as rsn_cd_key,
    trim(rsn_rej) as rsn_rej,
    trim(rlse_dt_cr_mgmt) as rlse_dt_cr_mgmt,
    trim(rqst_delv_dt) as rqst_delv_dt,
    trim(route) as route,
    trim(sls_doc) as sls_doc,
    trim(sls_doc_cat) as sls_doc_cat,
    trim(sls_doc_itm) as sls_doc_itm,
    trim(sls_doc_typ) as sls_doc_typ,
    trim(sls_emp_hist) as sls_emp_hist,
    trim(sls_org) as sls_org,
    trim(sls_doc_itm_cat) as sls_doc_itm_cat,
    trim(ship_to_prty) as ship_to_prty,
    trim(sold_to_prty) as sold_to_prty,
    SUM(bill_qty_cse) AS bill_qty_cse,
    SUM(bill_qty_pc) AS bill_qty_pc,
    SUM(bill_qty_difot) AS bill_qty_difot,
    SUM(bill_qty_otif) AS bill_qty_otif,
    SUM(bill_qty_sls_uom) AS bill_qty_sls_uom,
    SUM(cnfrm_qty_difot) AS cnfrm_qty_difot,
    SUM(cnfrm_qty_pc) AS cnfrm_qty_pc,
    SUM(delv_qty_cse) AS delv_qty_cse,
    SUM(delv_qty_pc) AS delv_qty_pc,
    SUM(delv_qty_sls_uom) AS delv_qty_sls_uom,
    SUM(est_nts) AS est_nts,
    SUM(nts_bill) AS nts_bill,
    SUM(net_invc_sls) AS net_invc_sls,
    SUM(fut_sls_qty) AS fut_sls_qty,
    SUM(gros_trd_sls) AS gros_trd_sls,
    SUM(net_amt) AS net_amt,
    SUM(net_prc) AS net_prc,
    SUM(net_bill_val) AS net_bill_val,
    SUM(net_ord_val) AS net_ord_val,
    SUM(ord_qty_cse) AS ord_qty_cse,
    SUM(ord_qty_pc) AS ord_qty_pc,
    SUM(ord_pc_qty) AS ord_pc_qty,
    SUM(ord_sls_qty) AS ord_sls_qty,
    SUM(tran_ldtm) AS tran_ldtm,
    SUM(unspp_qty) AS unspp_qty,
    SUM(unspp_val) AS unspp_val,
    SUM(vol_delv) AS vol_delv,
    SUM(vol_ord) AS vol_ord,
    trim(itg_invc_sls.cal_day) as cal_day,
    trim(base_uom) as base_uom,
    trim(curr_key) as curr_key,
    trim(doc_curr) as doc_curr,
    trim(sls_unit) as sls_unit,
    CASE
      WHEN edw_calendar_dim.fisc_per IS NULL
      THEN CAST(itg_invc_sls.fisc_yr as int)
      ELSE edw_calendar_dim.fisc_per
    END::number(18,0) AS fisc_yr,
    itg_invc_sls.fisc_yr::number(18,0) AS fisc_yr_src
  FROM source as itg_invc_sls
  LEFT OUTER JOIN edw_calendar_dim
    ON itg_invc_sls.bill_dt = edw_calendar_dim.cal_day
  GROUP BY
    trim(act_delv_dt),
    trim(act_good_iss_dt),
    trim(bill_to_prty),
    trim(bill_dt),
    trim(bill_ty),
    trim(bill_doc),
    trim(cmpy_cd),
    trim(cust_no),
    trim(delv_doc_crt_dt),
    trim(dstr_chnl),
    trim(DIV),
    trim(doc_crt_dt),
    trim(doc_dt),
    trim(good_iss_dt),
    trim(mat),
    trim(mat_avail_dt),
    trim(ord_rsn),
    trim(ovrl_rej_sts),
    trim(ovrl_sts_crd_chk),
    trim(payer),
    trim(plant),
    trim(prec_doc_itm),
    trim(prec_doc_num),
    trim(proof_delv_dt),
    trim(rsn_cd_key),
    trim(rsn_rej),
    trim(rlse_dt_cr_mgmt),
    trim(rqst_delv_dt),
    trim(route),
    trim(sls_doc),
    trim(sls_doc_cat),
    trim(sls_doc_itm),
    trim(sls_doc_typ),
    trim(sls_emp_hist),
    trim(sls_org),
    trim(sls_doc_itm_cat),
    trim(ship_to_prty),
    trim(sold_to_prty),
    trim(itg_invc_sls.cal_day),
    trim(base_uom),
    trim(curr_key),
    trim(doc_curr),
    trim(sls_unit),
    itg_invc_sls.fisc_yr,
    edw_calendar_dim.fisc_per

)

select * from final
