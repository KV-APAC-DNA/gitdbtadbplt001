{{
    config(
        materialized="incremental",
        incremental_strategy="append",
        post_hook="{{sap_transaction_processed_files('BWA_CDL_BILLING','vw_stg_sdl_sap_bw_billing','sdl_raw_sap_bw_billing')}}"
    )}}
with source as (
     select * from {{ ref('aspitg_integration__vw_stg_sdl_sap_bw_billing') }} ),

sap_transactional_processed_files as (
    select * from {{ source('aspwks_integration', 'sap_transactional_processed_files') }}
),
final as (
    select bill_num,
            bill_item,
            bill_dt,
            bill_type,
            sold_to,
            rt_promo,
            s_ord_item,
            doc_num,
            grs_wgt_dl,
            inv_qty,
            bill_qty,
            base_uom,
            exchg_rate,
            req_qty,
            sls_unit,
            payer,
            rebate_bas,
            no_inv_it,
            subtotal_1,
            subtotal_3,
            subtotal_4,
            subtotal_2,
            netval_inv,
            exchg_stat,
            zblqtycse,
            exratexacc,
            subtotal_6,
            gross_val,
            unit_of_wt,
            subtotal_5,
            numerator,
            cost,
            plant,
            volume_dl,
            loc_currcy,
            denomintr,
            volume_unit,
            scale_qty,
            cshdsc_bas,
            net_wgt_dl,
            tax_amt,
            rate_type,
            sls_org,
            exrate_acc,
            distr_chnl,
            doc_currcy,
            co_area,
            doc_categ,
            fisc_varnt,
            cost_center,
            matl_group,
            division,
            material,
            sls_grp,
            div_head,
            ship_point,
            wbs_elemt,
            bill_rule,
            bwapplnm,
            process_key,
            cust_grp,
            sls_off,
            refer_itm,
            matl_grp_3,
            price_dt,
            sls_emply,
            refer_doc,
            st_up_dte,
            stat_date,
            item_categ,
            prov_grp,
            matl_grp_5,
            prod_hier,
            itm_type,
            matl_grp_4,
            ship_to,
            bill_to_prty,
            rebate_grp,
            matl_grp_2,
            matl_grp_1,
            eanupc,
            mat_entrd,
            batch,
            stor_loc,
            created_on,
            serv_date,
            cust_grp5,
            sls_deal,
            bill_cat,
            cust_grp1,
            cust_grp3,
            trans_dt,
            cust_grp4,
            cust_grp2,
            stat_curr,
            ch_on,
            comp_cd,
            sls_dist,
            stor_no,
            record_mode,
            customer,
            cust_sls,
            oi_ebeln,
            oi_ebelp,
            zsd_pod,
            cdl_dttm,
            file_name,
            crt_dttm as curr_dt,
            updt_dttm
 from source
    where not exists (
    select 
        act_file_name 
    from sap_transactional_processed_files 
    where target_table_name='sdl_raw_sap_bw_billing' and sap_transactional_processed_files.act_file_name=source.file_name
  )
)

select * from final