{{
    config(
        sql_header= "ALTER SESSION SET TIMEZONE = 'Asia/Singapore';",
        materialized= "table"
        )
}}

--Import CTE
with source as (
    select * from {{ ref('aspitg_integration__vw_stg_sdl_sap_bw_sales') }}
),

--Logical CTE

--Final CTE
final as (
select
  doc_num,
  s_ord_item,
  rejectn_st,
  process_key,
  batch,
  to_date(created_on, 'yyyymmdd') as created_on,
  sls_deal,
  stor_loc,
  matl_grp,
  incoterms2,
  accnt_asgn,
  cust_grp,
  cond_pr_un,
  incoterms,
  cast(replace(subtotal_4, ',', '') as decimal(20, 4)) as subtotal_4,
  cast(replace(subtotal_5, ',', '') as decimal(20, 4)) as subtotal_5,
  cast(replace(net_price, ',', '') as decimal(20, 4)) as net_price,
  cast(replace(net_value, ',', '') as decimal(20, 4)) as net_value,
  cast(replace(net_wt_ap, ',', '') as decimal(20, 4)) as net_wt_ap,
  cond_unit,
  unit_of_wt,
  order_curr,
  stat_curr,
  loc_currcy,
  cast(replace(target_qty, ',', '') as decimal(20, 4)) as target_qty,
  cast(replace(targ_value, ',', '') as decimal(20, 4)) as targ_value,
  cast(replace(ord_items, ',', '') as decimal(20, 4)) as ord_items,
  cast(replace(zorqtycse, ',', '') as decimal(20, 4)) as zorqtycse,
  cast(replace(tax_value, ',', '') as decimal(20, 4)) as tax_value,
  cast(replace(exchg_rate, ',', '') as decimal(20, 4)) as exchg_rate,
  target_qu,
  cast(replace(cost, ',', '') as decimal(20, 4)) as cost,
  cast(replace(volume_ap, ',', '') as decimal(20, 4)) as volume_ap,
  volume_unit,
  cast(replace(exchg_stat, ',', '') as decimal(20, 4)) as exchg_stat,
  cast(replace(reqdel_qty, ',', '') as decimal(20, 4)) as reqdel_qty,
  cast(replace(lowr_bnd, ',', '') as decimal(20, 4)) as lowr_bnd,
  cast(replace(uppr_bnd, ',', '') as decimal(20, 4)) as uppr_bnd,
  cast(replace(numeratorz, ',', '') as decimal(20, 4)) as numeratorz,
  cast(replace(denomintrz, ',', '') as decimal(20, 4)) as denomintrz,
  cast(replace(numerator, ',', '') as decimal(20, 4)) as numerator,
  cast(replace(denomintr, ',', '') as decimal(20, 4)) as denomintr,
  min_dl_qty,
  cast(replace(subtotal_6, ',', '') as decimal(20, 4)) as subtotal_6,
  cast(replace(subtotal_3, ',', '') as decimal(20, 4)) as subtotal_3,
  wbs_elemt,
  refer_doc,
  cast(replace(subtotal_2, ',', '') as decimal(20, 4)) as subtotal_2,
  cast(replace(subtotal_1, ',', '') as decimal(20, 4)) as subtotal_1,
  doc_currcy,
  cast(replace(cml_or_qty, ',', '') as decimal(20, 4)) as cml_or_qty,
  cast(replace(cml_cd_qty, ',', '') as decimal(20, 4)) as cml_cd_qty,
  base_uom,
  material,
  refer_itm,
  fisc_varnt,
  apo_planned,
  log_sys,
  cast(replace(cml_cf_qty, ',', '') as decimal(20, 4)) as cml_cf_qty,
  sls_unit,
  to_date(doc_dt, 'yyyymmdd') as doc_dt,
  to_date(zreq_dt, 'yyyymmdd') as zreq_dt,
  zord_mth,
  sub_reason,
  doc_categr,
  div_head,
  to_date(trans_dt, 'yyyymmdd') as trans_dt,
  to_date(bill_dt, 'yyyymmdd') as bill_dt,
  prod_cat,
  cast(replace(exchg_crd, ',', '') as decimal(20, 4)) as exchg_crd,
  sales_dist,
  serv_dt,
  plant,
  rt_promo,
  mat_entrd,
  ship_point,
  prvdoc_ctg,
  crea_time,
  bilblk_itm,
  matl_grp_1,
  matl_grp_3,
  price_dt,
  matl_grp_4,
  matl_grp_5,
  route,
  sls_emply,
  bnd_ind,
  cast(replace(gross_wgt, ',', '') as decimal(20, 4)) as gross_wgt,
  stat_dt,
  division,
  to_date(st_up_dt, 'yyyymmdd') as st_up_dt,
  ship_stck,
  forwagent,
  bill_to_prty,
  prod_hier,
  item_categ,
  ship_to,
  payer,
  unld_pt_we,
  matl_grp_2,
  eanupc,
  created_by,
  sts_bill,
  order_prob,
  bwapplnm,
  quot_from,
  ord_reason,
  ch_on,
  reason_rej,
  comp_cd,
  distr_chan,
  sls_org,
  sls_grp,
  sls_off,
  doc_categ,
  rate_type,
  bill_block,
  cust_grp1,
  cust_grp2,
  cust_grp4,
  cust_grp3,
  cust_grp5,
  del_block,
  sold_to,
  quot_to,
  doc_type,
  sts_prc,
  sts_del,
  sts_itm,
  stor_no,
  record_mode,
  cast(replace(zordqtybu, ',', '') as decimal(20, 4)) as zordqtybu,
  zzp_num,
  zzp_itm,
  ztarqtycu,
  ztarqtybu,
  zhighritm,
  cdl_dttm,
  current_timestamp()::timestamp_ntz(9) as crt_dttm,
  current_timestamp()::timestamp_ntz(9) as updt_dttm,
  file_name
  from source
)

--Final select
select * from final 