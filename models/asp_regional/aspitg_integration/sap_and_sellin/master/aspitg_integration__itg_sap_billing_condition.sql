{{
    config(
        sql_header= "ALTER SESSION SET TIMEZONE = 'Asia/Singapore';",
        materialized="incremental",
        incremental_strategy="delete+insert",
        unique_key=["file_name"]
    )
}}


with source as(
    select * from {{ ref('aspitg_integration__vw_stg_sdl_sap_billing_condition') }}
),
final as(
    SELECT
    x.bill_num::VARCHAR(10) as bill_num,
    x.bill_item::VARCHAR(6) as bill_item,
    x.zstepnum::VARCHAR(3) as zstepnum,
    x.kncounter::VARCHAR(2) as kncounter,
    x.doc_number::VARCHAR(10) as doc_number,
    x.s_ord_item::VARCHAR(6) as s_ord_item,
    x.knart::VARCHAR(4) as knart,
    x.ch_on::VARCHAR(8) as ch_on,
    x.comp_code::VARCHAR(4) as comp_code,
    x.sales_dist::VARCHAR(6) as sales_dist,
    x.bill_type::VARCHAR(4) as bill_type,
    x.bill_date::VARCHAR(8) as bill_date,
    x.bill_cat::VARCHAR(1) as bill_cat,
    x.loc_currcy::VARCHAR(5) as loc_currcy,
    x.cust_group::VARCHAR(2) as cust_group,
    x.sold_to::VARCHAR(10) as sold_to,
    x.payer::VARCHAR(10) as payer,
    x.exrate_acc::VARCHAR(17) as exrate_acc,
    x.stat_curr::VARCHAR(5) as stat_curr,
    x.doc_categ::VARCHAR(2) as doc_categ,
    x.salesorg::VARCHAR(4) as salesorg,
    x.distr_chan::VARCHAR(2) as distr_chan,
    x.doc_currcy::VARCHAR(5) as doc_currcy,
    x.createdon::VARCHAR(8) as createdon,
    x.co_area::VARCHAR(4) as co_area,
    x.costcenter::VARCHAR(10) as costcenter,
    x.trans_date::VARCHAR(8) as trans_date,
    x.exchg_rate::VARCHAR(16) as exchg_rate,
    x.cust_grp1::VARCHAR(3) as cust_grp1,
    x.cust_grp2::VARCHAR(3) as cust_grp2,
    x.cust_grp3::VARCHAR(3) as cust_grp3,
    x.cust_grp4::VARCHAR(3) as cust_grp4,
    x.cust_grp5::VARCHAR(3) as cust_grp5,
    x.matl_group::VARCHAR(9) as matl_group,
    x.material::VARCHAR(18) as material,
    x.mat_entrd::VARCHAR(18) as mat_entrd,
    x.matl_grp_1::VARCHAR(3) as matl_grp_1,
    x.matl_grp_2::VARCHAR(3) as matl_grp_2,
    x.matl_grp_3::VARCHAR(3) as matl_grp_3,
    x.matl_grp_4::VARCHAR(3) as matl_grp_4,
    x.matl_grp_5::VARCHAR(3) as matl_grp_5,
    x.billtoprty::VARCHAR(10) as billtoprty,
    x.ship_to::VARCHAR(10) as ship_to,
    x.itm_type::VARCHAR(1) as itm_type,
    x.prod_hier::VARCHAR(18) as prod_hier,
    x.prov_group::VARCHAR(2) as prov_group,
    x.price_date::VARCHAR(8) as price_date,
    x.item_categ::VARCHAR(4) as item_categ,
    x.div_head::VARCHAR(2) as div_head,
    x.division::VARCHAR(2) as division,
    x.stat_date::VARCHAR(8) as stat_date,
    x.refer_doc::VARCHAR(10) as refer_doc,
    x.refer_itm::VARCHAR(6) as refer_itm,
    x.sales_off::VARCHAR(4) as sales_off,
    x.sales_grp::VARCHAR(3) as sales_grp,
    x.wbs_elemt::VARCHAR(24) as wbs_elemt,
    x.calday::VARCHAR(8) as calday,
    x.calmonth::VARCHAR(6) as calmonth,
    x.calweek::VARCHAR(6) as calweek,
    x.fiscper::VARCHAR(7) as fiscper,
    x.fiscvarnt::VARCHAR(2) as fiscvarnt,
    x.knclass::VARCHAR(4) as knclass,
    x.knorigin::VARCHAR(4) as knorigin,
    x.kntyp::VARCHAR(4) as kntyp,
    CAST((
        x.knval * POWER(10, (
        2 - x.currdec
        ))
    ) as NUMBER(17,3)) AS knval,
    x.kprice::NUMBER(173) as kprice,
    x.kinak::VARCHAR(1) as kinak,
    x.kstat::VARCHAR(1) as kstat,
    x.storno::VARCHAR(1) as storno,
    x.rt_promo::VARCHAR(10) as rt_promo,
    x.rebate_grp::VARCHAR(2) as rebate_grp,
    x.bwapplnm::VARCHAR(30) as bwapplnm,
    x.processkey::VARCHAR(3) as processkey,
    x.eanupc::VARCHAR(18) as eanupc,
    x.createdby::VARCHAR(12) as createdby,
    x.serv_date::VARCHAR(8) as serv_date,
    x.inv_qty::NUMBER(173) as inv_qty,
    x.actual_quantity_pc::NUMBER(173) as actual_quantity_pc,
    x.forwagent::VARCHAR(10) as forwagent,
    x.salesemply::VARCHAR(8) as salesemply,
    x.sales_unit::VARCHAR(3) as sales_unit,
    x.kappl::VARCHAR(2) as kappl,
    x.acrn_id::VARCHAR(2) as acrn_id,
    x.recordmode::VARCHAR(1) as recordmode,
    x.crt_dttm as crt_dttm,
    x.source_file_name::VARCHAR(255) as source_file_name
FROM (
  SELECT
    sbc.bill_num,
    sbc.bill_item,
    sbc.zstepnum,
    sbc.kncounter,
    sbc.doc_number,
    sbc.s_ord_item,
    sbc.knart,
    sbc.ch_on,
    sbc.comp_code,
    sbc.sales_dist,
    sbc.bill_type,
    sbc.bill_date,
    sbc.bill_cat,
    sbc.loc_currcy,
    sbc.cust_group,
    sbc.sold_to,
    sbc.payer,
    sbc.exrate_acc,
    sbc.stat_curr,
    sbc.doc_categ,
    sbc.salesorg,
    sbc.distr_chan,
    sbc.doc_currcy,
    sbc.createdon,
    sbc.co_area,
    sbc.costcenter,
    sbc.trans_date,
    sbc.exchg_rate,
    sbc.cust_grp1,
    sbc.cust_grp2,
    sbc.cust_grp3,
    sbc.cust_grp4,
    sbc.cust_grp5,
    sbc.matl_group,
    sbc.material,
    sbc.mat_entrd,
    sbc.matl_grp_1,
    sbc.matl_grp_2,
    sbc.matl_grp_3,
    sbc.matl_grp_4,
    sbc.matl_grp_5,
    sbc.billtoprty,
    sbc.ship_to,
    sbc.itm_type,
    sbc.prod_hier,
    sbc.prov_group,
    sbc.price_date,
    sbc.item_categ,
    sbc.div_head,
    sbc.division,
    sbc.stat_date,
    sbc.refer_doc,
    sbc.refer_itm,
    sbc.sales_off,
    sbc.sales_grp,
    sbc.wbs_elemt,
    sbc.calday,
    sbc.calmonth,
    sbc.calweek,
    sbc.fiscper,
    sbc.fiscvarnt,
    sbc.knclass,
    sbc.knorigin,
    sbc.kntyp,
    sbc.knval,
    sbc.kprice,
    sbc.kinak,
    sbc.kstat,
    sbc.storno,
    sbc.rt_promo,
    sbc.rebate_grp,
    sbc.bwapplnm,
    sbc.processkey,
    sbc.eanupc,
    sbc.createdby,
    sbc.serv_date,
    sbc.inv_qty,
    CASE WHEN knart = 'ZKSD' THEN (
      emu.uomz1d * sbc.inv_qty
    ) ELSE 0 END AS actual_quantity_pc,
    sbc.forwagent,
    sbc.salesemply,
    sbc.sales_unit,
    sbc.kappl,
    sbc.acrn_id,
    sbc.recordmode,
    sbc.crt_dttm,
    sbc.source_file_name,
    currx.currkey,
    CASE WHEN CAST(LENGTH(currx.currkey) AS INT) > 0 THEN currx.currdec ELSE 2 END AS currdec
  FROM source AS sbc
  LEFT JOIN {{ source('snapaspitg_integration', 'itg_crncy_mult') }} AS currx
    ON sbc.loc_currcy = currx.currkey
  LEFT JOIN {{ ref('aspedw_integration__edw_material_uom') }} AS emu
    ON LTRIM(sbc.material, 0) = LTRIM(emu.material, 0) AND sbc.sales_unit = emu.unit
) AS x
)

select * from final