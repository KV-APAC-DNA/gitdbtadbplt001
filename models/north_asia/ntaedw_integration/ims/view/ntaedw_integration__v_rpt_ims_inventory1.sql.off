-- --ntaedw_integration__v_rpt_ims_inventory
-- with edw_ims_inventory_fact as
-- (
--     select * from snapntaedw_integration.edw_ims_inventory_fact
-- ),
-- itg_tw_ims_dstr_prod_price_map as 
-- (
--     select * from snapntaitg_integration.itg_tw_ims_dstr_prod_price_map
-- ),
-- v_intrm_calendar_ims as
-- (
--     select * from snapntaedw_integration.v_intrm_calendar_ims
-- ), 
-- edw_product_attr_dim as
-- (
--     select * from snapaspedw_integration.edw_product_attr_dim
-- ), 
-- edw_customer_attr_flat_dim as
-- (
--     select * from snapaspedw_integration.edw_customer_attr_flat_dim
-- ), 
-- itg_ims_dstr_cust_attr as
-- (
--     select * from snapntaitg_integration.itg_ims_dstr_cust_attr
-- ), 
-- V_DLY_IMS_TXN_MSL as
-- (
--     select * from snapntaedw_integration.V_DLY_IMS_TXN_MSL
-- ),
-- a as
-- (
--     SELECT a.invnt_dt,
--     a.dstr_cd,
--     (((a.dstr_cd)::TEXT || (' - '::CHARACTER VARYING)::TEXT) || (a.dstr_nm)::TEXT) AS dstr_nm,
--     a.cust_nm AS cust_name,
--     COALESCE("k".dstr_cust_clsn1, 'Not Available'::CHARACTER VARYING) AS channel1,
--     COALESCE("k".dstr_cust_clsn2, 'Not Available'::CHARACTER VARYING) AS channel2,
--     b.fisc_per,
--     b.cal_wk AS fisc_wk,
--     b.no_of_wks,
--     b.fisc_wk_num,
--     a.prod_cd,
--     a.prod_nm,
--     a.ean_num,
--     sum(a.invnt_qty) AS invnt_qty,
--     sum(a.invnt_amt) AS invnt_amt,
--     COALESCE(COALESCE(a.sls_rep_nm, a.sls_rep_cd), 'Not Available'::CHARACTER VARYING) AS sls_rep_nm,
--     a.sls_rep_cd,
--     CASE 
--         WHEN ((a.ctry_cd)::TEXT = ('KR'::CHARACTER VARYING)::TEXT)
--             THEN 'South Korea'::CHARACTER VARYING
--         WHEN ((a.ctry_cd)::TEXT = ('TW'::CHARACTER VARYING)::TEXT)
--             THEN 'Taiwan'::CHARACTER VARYING
--         WHEN ((a.ctry_cd)::TEXT = ('HK'::CHARACTER VARYING)::TEXT)
--             THEN 'Hong Kong'::CHARACTER VARYING
--         ELSE NULL::CHARACTER VARYING
--         END AS ctry_nm,
--     a.crncy_cd AS from_crncy,
--     g.to_crncy,
--     a.chn_uom,
--     g.ex_rt,
--     CASE 
--         WHEN (
--                 ((a.ctry_cd)::TEXT = ('TW'::CHARACTER VARYING)::TEXT)
--                 AND (
--                     (f.prod_hier_l1 IS NULL)
--                     OR ((f.prod_hier_l1)::TEXT = (''::CHARACTER VARYING)::TEXT)
--                     )
--                 )
--             THEN 'Taiwan'::CHARACTER VARYING
--         WHEN (
--                 ((a.ctry_cd)::TEXT = ('KR'::CHARACTER VARYING)::TEXT)
--                 AND (
--                     (f.prod_hier_l1 IS NULL)
--                     OR ((f.prod_hier_l1)::TEXT = (''::CHARACTER VARYING)::TEXT)
--                     )
--                 )
--             THEN 'Korea'::CHARACTER VARYING
--         WHEN (
--                 ((a.ctry_cd)::TEXT = ('HK'::CHARACTER VARYING)::TEXT)
--                 AND (
--                     (f.prod_hier_l1 IS NULL)
--                     OR ((f.prod_hier_l1)::TEXT = (''::CHARACTER VARYING)::TEXT)
--                     )
--                 )
--             THEN 'HK'::CHARACTER VARYING
--         ELSE COALESCE(f.prod_hier_l1, '#'::CHARACTER VARYING)
--         END AS prod_hier_l1,
--     COALESCE(f.prod_hier_l2, '#'::CHARACTER VARYING) AS prod_hier_l2,
--     COALESCE(f.prod_hier_l3, '#'::CHARACTER VARYING) AS prod_hier_l3,
--     COALESCE(f.prod_hier_l4, '#'::CHARACTER VARYING) AS prod_hier_l4,
--     COALESCE(f.prod_hier_l5, '#'::CHARACTER VARYING) AS prod_hier_l5,
--     COALESCE(f.prod_hier_l6, '#'::CHARACTER VARYING) AS prod_hier_l6,
--     COALESCE(f.prod_hier_l7, '#'::CHARACTER VARYING) AS prod_hier_l7,
--     COALESCE(f.prod_hier_l8, '#'::CHARACTER VARYING) AS prod_hier_l8,
--     COALESCE(f.prod_hier_l9, '#'::CHARACTER VARYING) AS prod_hier_l9,
--     f.sap_matl_num,
--     COALESCE(f.lcl_prod_nm, '#'::CHARACTER VARYING) AS lcl_prod_nm,
--     COALESCE(h.sls_grp, ('Not Available'::CHARACTER VARYING)::TEXT) AS sls_grp,
--     CASE 
--         WHEN (
--                 (h.store_typ IS NULL)
--                 OR (((h.store_typ)::CHARACTER VARYING)::TEXT = (''::CHARACTER VARYING)::TEXT)
--                 )
--             THEN ('Not Available'::CHARACTER VARYING)::TEXT
--         ELSE h.store_typ
--         END AS store_typ,
--     CASE 
--         WHEN (
--                 (
--                     (
--                         (
--                             ((a.prod_cd)::TEXT ~ ~ ('1U%'::CHARACTER VARYING)::TEXT)
--                             OR ((a.prod_cd)::TEXT ~ ~ ('COUNTER TOP%'::CHARACTER VARYING)::TEXT)
--                             )
--                         OR ((a.prod_cd)::TEXT ~ ~ ('DUMPBIN\012\012%'::CHARACTER VARYING)::TEXT)
--                         )
--                     OR (a.prod_cd IS NULL)
--                     )
--                 OR ((a.prod_cd)::TEXT = (''::CHARACTER VARYING)::TEXT)
--                 )
--             THEN 'non sellable products'::CHARACTER VARYING
--         ELSE 'sellable products'::CHARACTER VARYING
--         END AS non_sellable_product,
--     a.sell_out_price_manual AS sell_in_price_manual,
--     a.storage_name,
--     a.area
-- FROM (
--     (
--         (
--             (
--                 (
--                     (
--                         SELECT inv_data.invnt_dt,
--                             inv_data.dstr_cd,
--                             inv_data.dstr_nm,
--                             inv_data.cust_nm,
--                             inv_data.prod_cd,
--                             inv_data.prod_nm,
--                             inv_data.ean_num,
--                             inv_data.uom,
--                             inv_data.invnt_qty,
--                             inv_data.invnt_amt,
--                             inv_data.avg_prc_amt,
--                             inv_data.safety_stock,
--                             inv_data.bad_invnt_qty,
--                             inv_data.book_invnt_qty,
--                             inv_data.convs_amt,
--                             inv_data.prch_disc_amt,
--                             inv_data.end_invnt_qty,
--                             inv_data.batch_no,
--                             inv_data.chn_uom,
--                             inv_data.sls_rep_cd,
--                             inv_data.sls_rep_nm,
--                             inv_data.ctry_cd,
--                             inv_data.crncy_cd,
--                             inv_data.crt_dttm,
--                             inv_data.updt_dttm,
--                             inv_data.sell_out_price_manual,
--                             inv_data.storage_name,
--                             inv_data.area
--                         FROM (
--                             SELECT edw_ims_inventory_fact.invnt_dt,
--                                 edw_ims_inventory_fact.dstr_cd,
--                                 edw_ims_inventory_fact.dstr_nm,
--                                 edw_ims_inventory_fact.cust_nm,
--                                 edw_ims_inventory_fact.prod_cd,
--                                 edw_ims_inventory_fact.prod_nm,
--                                 edw_ims_inventory_fact.ean_num,
--                                 edw_ims_inventory_fact.uom,
--                                 edw_ims_inventory_fact.invnt_qty,
--                                 edw_ims_inventory_fact.invnt_amt,
--                                 edw_ims_inventory_fact.avg_prc_amt,
--                                 edw_ims_inventory_fact.safety_stock,
--                                 edw_ims_inventory_fact.bad_invnt_qty,
--                                 edw_ims_inventory_fact.book_invnt_qty,
--                                 edw_ims_inventory_fact.convs_amt,
--                                 edw_ims_inventory_fact.prch_disc_amt,
--                                 edw_ims_inventory_fact.end_invnt_qty,
--                                 edw_ims_inventory_fact.batch_no,
--                                 edw_ims_inventory_fact.chn_uom,
--                                 edw_ims_inventory_fact.sls_rep_cd,
--                                 edw_ims_inventory_fact.sls_rep_nm,
--                                 edw_ims_inventory_fact.ctry_cd,
--                                 edw_ims_inventory_fact.crncy_cd,
--                                 edw_ims_inventory_fact.crt_dttm,
--                                 edw_ims_inventory_fact.updt_dttm,
--                                 pmf.sell_out_price_manual,
--                                 edw_ims_inventory_fact.storage_name,
--                                 edw_ims_inventory_fact.area
--                             FROM (
--                                 edw_ims_inventory_fact edw_ims_inventory_fact JOIN itg_tw_ims_dstr_prod_price_map pmf ON (
--                                         (
--                                             (
--                                                 (
--                                                     (
--                                                         (
--                                                             (
--                                                                 (
--                                                                     ((edw_ims_inventory_fact.dstr_cd)::TEXT = (pmf.dstr_cd)::TEXT)
--                                                                     AND ((edw_ims_inventory_fact.prod_cd)::TEXT = (pmf.dstr_prod_cd)::TEXT)
--                                                                     )
--                                                                 AND (ltrim((edw_ims_inventory_fact.ean_num)::TEXT, ((0)::CHARACTER VARYING)::TEXT) = ltrim((pmf.ean_cd)::TEXT, ((0)::CHARACTER VARYING)::TEXT))
--                                                                 )
--                                                             AND (edw_ims_inventory_fact.invnt_dt >= pmf.promotion_start_date)
--                                                             )
--                                                         AND (edw_ims_inventory_fact.invnt_dt <= pmf.promotion_end_date)
--                                                         )
--                                                     AND (
--                                                         (pmf.dstr_cd IS NOT NULL)
--                                                         OR ((pmf.dstr_cd)::TEXT <> (''::CHARACTER VARYING)::TEXT)
--                                                         )
--                                                     )
--                                                 AND (
--                                                     (pmf.dstr_prod_cd IS NOT NULL)
--                                                     OR ((pmf.dstr_prod_cd)::TEXT <> (''::CHARACTER VARYING)::TEXT)
--                                                     )
--                                                 )
--                                             AND (
--                                                 (pmf.ean_cd IS NOT NULL)
--                                                 OR ((pmf.ean_cd)::TEXT <> (''::CHARACTER VARYING)::TEXT)
--                                                 )
--                                             )
--                                         )
--                                 )
--                             ) inv_data
                        
--                         UNION ALL
                        
--                         SELECT inv.invnt_dt,
--                             inv.dstr_cd,
--                             inv.dstr_nm,
--                             inv.cust_nm,
--                             inv.prod_cd,
--                             inv.prod_nm,
--                             inv.ean_num,
--                             inv.uom,
--                             inv.invnt_qty,
--                             inv.invnt_amt,
--                             inv.avg_prc_amt,
--                             inv.safety_stock,
--                             inv.bad_invnt_qty,
--                             inv.book_invnt_qty,
--                             inv.convs_amt,
--                             inv.prch_disc_amt,
--                             inv.end_invnt_qty,
--                             inv.batch_no,
--                             inv.chn_uom,
--                             inv.sls_rep_cd,
--                             inv.sls_rep_nm,
--                             inv.ctry_cd,
--                             inv.crncy_cd,
--                             inv.crt_dttm,
--                             inv.updt_dttm,
--                             pm.sell_out_price_manual,
--                             inv.storage_name,
--                             inv.area
--                         FROM (
--                             edw_ims_inventory_fact inv LEFT JOIN (
--                                 SELECT itg_tw_ims_dstr_prod_price_map.dstr_cd,
--                                     itg_tw_ims_dstr_prod_price_map.dstr_nm,
--                                     itg_tw_ims_dstr_prod_price_map.ean_cd,
--                                     itg_tw_ims_dstr_prod_price_map.dstr_prod_cd,
--                                     itg_tw_ims_dstr_prod_price_map.dstr_prod_nm,
--                                     itg_tw_ims_dstr_prod_price_map.sell_out_price_manual,
--                                     itg_tw_ims_dstr_prod_price_map.promotion_start_date,
--                                     itg_tw_ims_dstr_prod_price_map.promotion_end_date,
--                                     itg_tw_ims_dstr_prod_price_map.crt_dttm,
--                                     itg_tw_ims_dstr_prod_price_map.updt_dttm
--                                 FROM itg_tw_ims_dstr_prod_price_map
--                                 WHERE (
--                                         (
--                                             (itg_tw_ims_dstr_prod_price_map.dstr_cd IS NULL)
--                                             OR ((itg_tw_ims_dstr_prod_price_map.dstr_cd)::TEXT = (''::CHARACTER VARYING)::TEXT)
--                                             )
--                                         AND (
--                                             (itg_tw_ims_dstr_prod_price_map.dstr_prod_cd IS NULL)
--                                             OR ((itg_tw_ims_dstr_prod_price_map.dstr_prod_cd)::TEXT = (''::CHARACTER VARYING)::TEXT)
--                                             )
--                                         )
--                                 ) pm ON (
--                                     (
--                                         (
--                                             (ltrim((inv.ean_num)::TEXT, ((0)::CHARACTER VARYING)::TEXT) = ltrim((pm.ean_cd)::TEXT, ((0)::CHARACTER VARYING)::TEXT))
--                                             AND (inv.invnt_dt >= pm.promotion_start_date)
--                                             )
--                                         AND (inv.invnt_dt <= pm.promotion_end_date)
--                                         )
--                                     )
--                             )
--                         WHERE (
--                                 NOT (
--                                     (((((inv.invnt_dt)::CHARACTER VARYING)::TEXT || (inv.dstr_cd)::TEXT) || (inv.prod_cd)::TEXT) || (inv.ean_num)::TEXT) IN (
--                                         SELECT (((((inv_data.invnt_dt)::CHARACTER VARYING)::TEXT || (inv_data.dstr_cd)::TEXT) || (inv_data.prod_cd)::TEXT) || (inv_data.ean_num)::TEXT)
--                                         FROM (
--                                             SELECT edw_ims_inventory_fact.invnt_dt,
--                                                 edw_ims_inventory_fact.dstr_cd,
--                                                 edw_ims_inventory_fact.dstr_nm,
--                                                 edw_ims_inventory_fact.cust_nm,
--                                                 edw_ims_inventory_fact.prod_cd,
--                                                 edw_ims_inventory_fact.prod_nm,
--                                                 edw_ims_inventory_fact.ean_num,
--                                                 edw_ims_inventory_fact.uom,
--                                                 edw_ims_inventory_fact.invnt_qty,
--                                                 edw_ims_inventory_fact.invnt_amt,
--                                                 edw_ims_inventory_fact.avg_prc_amt,
--                                                 edw_ims_inventory_fact.safety_stock,
--                                                 edw_ims_inventory_fact.bad_invnt_qty,
--                                                 edw_ims_inventory_fact.book_invnt_qty,
--                                                 edw_ims_inventory_fact.convs_amt,
--                                                 edw_ims_inventory_fact.prch_disc_amt,
--                                                 edw_ims_inventory_fact.end_invnt_qty,
--                                                 edw_ims_inventory_fact.batch_no,
--                                                 edw_ims_inventory_fact.chn_uom,
--                                                 edw_ims_inventory_fact.sls_rep_cd,
--                                                 edw_ims_inventory_fact.sls_rep_nm,
--                                                 edw_ims_inventory_fact.ctry_cd,
--                                                 edw_ims_inventory_fact.crncy_cd,
--                                                 edw_ims_inventory_fact.crt_dttm,
--                                                 edw_ims_inventory_fact.updt_dttm,
--                                                 pmf.sell_out_price_manual,
--                                                 edw_ims_inventory_fact.storage_name,
--                                                 edw_ims_inventory_fact.area
--                                             FROM (
--                                                 edw_ims_inventory_fact edw_ims_inventory_fact JOIN itg_tw_ims_dstr_prod_price_map pmf ON (
--                                                         (
--                                                             (
--                                                                 (
--                                                                     (
--                                                                         (
--                                                                             (
--                                                                                 (
--                                                                                     ((edw_ims_inventory_fact.dstr_cd)::TEXT = (pmf.dstr_cd)::TEXT)
--                                                                                     AND ((edw_ims_inventory_fact.prod_cd)::TEXT = (pmf.dstr_prod_cd)::TEXT)
--                                                                                     )
--                                                                                 AND (ltrim((edw_ims_inventory_fact.ean_num)::TEXT, ((0)::CHARACTER VARYING)::TEXT) = ltrim((pmf.ean_cd)::TEXT, ((0)::CHARACTER VARYING)::TEXT))
--                                                                                 )
--                                                                             AND (edw_ims_inventory_fact.invnt_dt >= pmf.promotion_start_date)
--                                                                             )
--                                                                         AND (edw_ims_inventory_fact.invnt_dt <= pmf.promotion_end_date)
--                                                                         )
--                                                                     AND (
--                                                                         (pmf.dstr_cd IS NOT NULL)
--                                                                         OR ((pmf.dstr_cd)::TEXT <> (''::CHARACTER VARYING)::TEXT)
--                                                                         )
--                                                                     )
--                                                                 AND (
--                                                                     (pmf.dstr_prod_cd IS NOT NULL)
--                                                                     OR ((pmf.dstr_prod_cd)::TEXT <> (''::CHARACTER VARYING)::TEXT)
--                                                                     )
--                                                                 )
--                                                             AND (
--                                                                 (pmf.ean_cd IS NOT NULL)
--                                                                 OR ((pmf.ean_cd)::TEXT <> (''::CHARACTER VARYING)::TEXT)
--                                                                 )
--                                                             )
--                                                         )
--                                                 )
--                                             ) inv_data
--                                         )
--                                     )
--                                 )
--                         ) a LEFT JOIN v_intrm_calendar_ims b ON ((b.cal_day = a.invnt_dt))
--                     ) LEFT JOIN (
--                     SELECT DISTINCT (edw_product_attr_dim.ean)::CHARACTER VARYING(100) AS ean_num,
--                         edw_product_attr_dim.cntry,
--                         edw_product_attr_dim.sap_matl_num,
--                         edw_product_attr_dim.prod_hier_l1,
--                         edw_product_attr_dim.prod_hier_l2,
--                         edw_product_attr_dim.prod_hier_l3,
--                         edw_product_attr_dim.prod_hier_l4,
--                         edw_product_attr_dim.prod_hier_l5,
--                         edw_product_attr_dim.prod_hier_l6,
--                         edw_product_attr_dim.prod_hier_l7,
--                         edw_product_attr_dim.prod_hier_l8,
--                         edw_product_attr_dim.prod_hier_l9,
--                         edw_product_attr_dim.lcl_prod_nm
--                     FROM edw_product_attr_dim edw_product_attr_dim
--                     ) f ON (
--                         (
--                             ((f.ean_num)::TEXT = (a.ean_num)::TEXT)
--                             AND ((f.cntry)::TEXT = (a.ctry_cd)::TEXT)
--                             )
--                         )
--                 ) LEFT JOIN (
--                 SELECT edw_customer_attr_flat_dim.sold_to_party,
--                     "max" ((edw_customer_attr_flat_dim.sls_grp)::TEXT) AS sls_grp,
--                     "max" ((edw_customer_attr_flat_dim.store_typ)::TEXT) AS store_typ
--                 FROM edw_customer_attr_flat_dim
--                 GROUP BY edw_customer_attr_flat_dim.sold_to_party
--                 ) h ON (((a.dstr_cd)::TEXT = (h.sold_to_party)::TEXT))
--             ) LEFT JOIN (
--             SELECT DISTINCT itg_ims_dstr_cust_attr.dstr_cd,
--                 "replace" (
--                     "replace" (
--                         "replace" (
--                             "replace" (
--                                 (itg_ims_dstr_cust_attr.dstr_cust_cd)::TEXT,
--                                 ('Indirect'::CHARACTER VARYING)::TEXT,
--                                 (''::CHARACTER VARYING)::TEXT
--                                 ),
--                             ('Direct'::CHARACTER VARYING)::TEXT,
--                             (''::CHARACTER VARYING)::TEXT
--                             ),
--                         ('Indi'::CHARACTER VARYING)::TEXT,
--                         (''::CHARACTER VARYING)::TEXT
--                         ),
--                     ('Dire'::CHARACTER VARYING)::TEXT,
--                     (''::CHARACTER VARYING)::TEXT
--                     ) AS dstr_cust_cd,
--                 itg_ims_dstr_cust_attr.dstr_cust_clsn1,
--                 itg_ims_dstr_cust_attr.dstr_cust_clsn2
--             FROM itg_ims_dstr_cust_attr
--             ) "k" ON (
--                 (
--                     (("k".dstr_cd)::TEXT = (a.dstr_cd)::TEXT)
--                     AND ("k".dstr_cust_cd = (a.cust_nm)::TEXT)
--                     )
--                 )
--         ) LEFT JOIN v_intrm_crncy_exch g ON (((a.crncy_cd)::TEXT = (g.from_crncy)::TEXT))
--     )
-- WHERE (pgdate_part(('year'::CHARACTER VARYING)::TEXT, (a.invnt_dt)::TIMESTAMP without TIME zone) > (pgdate_part(('year'::CHARACTER VARYING)::TEXT, ('now'::CHARACTER VARYING)::TIMESTAMP without TIME zone) - (3)::DOUBLE PRECISION))
-- GROUP BY a.invnt_dt,
--     a.dstr_cd,
--     a.dstr_nm,
--     a.cust_nm,
--     "k".dstr_cust_clsn1,
--     "k".dstr_cust_clsn2,
--     b.fisc_per,
--     b.cal_wk,
--     b.no_of_wks,
--     b.fisc_wk_num,
--     a.prod_cd,
--     a.prod_nm,
--     a.ean_num,
--     a.invnt_amt,
--     a.invnt_qty,
--     a.sls_rep_cd,
--     a.sls_rep_nm,
--     a.ctry_cd,
--     a.crncy_cd,
--     g.to_crncy,
--     a.chn_uom,
--     g.ex_rt,
--     f.prod_hier_l1,
--     f.prod_hier_l2,
--     f.prod_hier_l3,
--     f.prod_hier_l4,
--     f.prod_hier_l5,
--     f.prod_hier_l6,
--     f.prod_hier_l7,
--     f.prod_hier_l8,
--     f.prod_hier_l9,
--     f.lcl_prod_nm,
--     f.sap_matl_num,
--     h.sls_grp,
--     h.store_typ,
--     a.sell_out_price_manual,
--     a.storage_name,
--     a.area;

-- )
-- select count(*) from a