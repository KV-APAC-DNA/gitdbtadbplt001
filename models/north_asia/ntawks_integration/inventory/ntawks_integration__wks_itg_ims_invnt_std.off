with sdl_tw_ims_dstr_std_stock as(
    select * from {{ ref('ntaitg_integration__sdl_tw_ims_dstr_std_stock') }}
),
tw_ims_distributor_ingestion_metadata as(
    select * from DEV_DNA_CORE.SNAPNTAWKS_INTEGRATION.TW_IMS_DISTRIBUTOR_INGESTION_METADATA
),
union1 as(
    SELECT SRC.invnt_dt,
       SRC.dstr_cd,
       dstr_nm,
       SRC.prod_cd,
       prod_nm,
       SRC.ean_num,
       cust_nm,
       invnt_qty,
       invnt_amt,
       avg_prc_amt,
       safety_stock,
       bad_invnt_qty,
       book_invnt_qty,
       convs_amt,
       prch_disc_amt,
       end_invnt_qty,
       batch_no,
       uom,
       sls_rep_cd,
       sls_rep_nm,
       SRC.ctry_cd,
       crncy_cd,
       SRC.chn_uom,
       null as storage_name,
       current_timestamp()::timestamp_ntz(9) AS UPDT_DTTM
FROM (SELECT inventory_date AS invnt_dt,
             stock.distributor_code AS dstr_cd,
             COALESCE(meta.dstr_nm,'#') AS dstr_nm,
             distributor_product_code AS prod_cd,
             --MAX(chn_desp) AS prod_nm, -- need to confirm
             MAX(distributors_product_name) AS prod_nm,
             -- need to confirm
             ean AS ean_num,
             NULL AS cust_nm,
             SUM(quantity) AS invnt_qty,
             SUM(total_cost) AS invnt_amt,
             NULL AS avg_prc_amt,
             NULL AS safety_stock,
             NULL AS bad_invnt_qty,
             NULL AS book_invnt_qty,
             NULL AS convs_amt,
             NULL AS prch_disc_amt,
             NULL AS end_invnt_qty,
             NULL AS batch_no,
             NULL AS uom,
             NULL AS sls_rep_cd,
             NULL AS sls_rep_nm,
             'TW' AS ctry_cd,
             'TWD' AS crncy_cd,
             MAX(uom) AS chn_uom
      FROM sdl_tw_ims_dstr_std_stock stock
        LEFT JOIN (SELECT DISTINCT ctry_cd,
                          distributor_code,
                          dstr_nm
                   FROM tw_ims_distributor_ingestion_metadata
                   WHERE subject_area = 'Stock-Data'
                   AND   ctry_cd = 'TW') meta ON stock.distributor_code = meta.distributor_code
      GROUP BY inventory_date,
               distributor_product_code,
               stock.distributor_code,
               ean,
               meta.dstr_nm) src
),
union2 as(
    SELECT SRC.invnt_dt,
       SRC.dstr_cd,
       dstr_nm,
       SRC.prod_cd,
       prod_nm,
       SRC.ean_num,
       cust_nm,
       invnt_qty,
       invnt_amt,
       avg_prc_amt,
       safety_stock,
       bad_invnt_qty,
       book_invnt_qty,
       convs_amt,
       prch_disc_amt,
       end_invnt_qty,
       batch_no,
       uom,
       sls_rep_cd,
       sls_rep_nm,
       SRC.ctry_cd,
       crncy_cd,
       SRC.chn_uom,
        SRC.storage_name,
       current_timestamp()::timestamp_ntz(9) AS UPDT_DTTM
FROM (SELECT inventory_date AS invnt_dt,
             stock.distributor_code AS dstr_cd,
             case when filename like '%PXStock%' then dstr_nm||'_PXStock'
when filename like '%PXStore%' then dstr_nm||'_PXStore'
else
 COALESCE(meta.dstr_nm,'#') end AS dstr_nm,
             distributor_product_code AS prod_cd,
             --MAX(chn_desp) AS prod_nm, -- need to confirm
             MAX(distributors_product_name) AS prod_nm,
             -- need to confirm
             ean AS ean_num,
             NULL AS cust_nm,
             SUM(quantity) AS invnt_qty,
             SUM(total_cost) AS invnt_amt,
             NULL AS avg_prc_amt,
             NULL AS safety_stock,
             NULL AS bad_invnt_qty,
             NULL AS book_invnt_qty,
             NULL AS convs_amt,
             NULL AS prch_disc_amt,
             NULL AS end_invnt_qty,
             NULL AS batch_no,
             NULL AS uom,
             NULL AS sls_rep_cd,
             NULL AS sls_rep_nm,
             'TW' AS ctry_cd,
             'TWD' AS crncy_cd,
             MAX(uom) AS chn_uom,
            storage_name
      FROM sdl_tw_ims_dstr_std_stock stock
        LEFT JOIN (SELECT DISTINCT ctry_cd,
                          distributor_code,
                          dstr_nm
                   FROM tw_ims_distributor_ingestion_metadata
                   WHERE subject_area = 'Stock-Data'
                   AND   ctry_cd = 'TW') meta ON stock.distributor_code = meta.distributor_code
      GROUP BY inventory_date,
               distributor_product_code,
               stock.distributor_code,
               ean,
               meta.dstr_nm,storage_name,filename) src
),
transformed as(
    select * from union1
    union 
    select * from union2
)
select * from transformed