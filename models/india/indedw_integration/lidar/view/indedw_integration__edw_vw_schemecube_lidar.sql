
with edw_rpt_schemeutilize_cube as (
    select * from {{ ref('indedw_integration__edw_rpt_schemeutilize_cube') }}
),

edw_rpt_schemeutilize_cube_2020_2021 as (
    select * from {{ source('indedw_integration', 'edw_rpt_schemeutilize_cube_2020_2021') }}
),

v_rpt_sales_details_with_history as (
    select * from {{ ref('indedw_integration__v_rpt_sales_details_with_history') }}
),

result as (
SELECT sch.fisc_yr AS year,
    sch.qtr AS quarter,
    sch.mth_yyyymm AS month,
    sch.rtruniquecode,
    sch.retailer_name,
    sch.region_name,
    sch.zone_name,
    sch.territory_name,
    sch.state_name,
    sch.town_name,
    sch.business_channel,
    sch.channel_name,
    sch.class_desc,
    sch.billedprdccode,
    sch.billedprdbatcode,
    sch.product_name,
    sch.franchise_name,
    sch.brand_name,
    sch.product_category_name,
    sch.variant_name,
    sch.mothersku_name,
    sch.schemecode,
    sch.schemedescription,
    sch.schtype,
    sch.schemetype,
    sch.companyschemecode,
    sch.schemetype1,
    sch.schemetype2,
    sch.schvaluetype,
    sch.schemefreeproduct,
    sch.sch_schemeutilizedamt,
    sch.sch_schemeutilizedqty,
    sch.sch_billedqty,
    sch.sch_schdiscperc,
    sch.sch_billedrate,
    sdt.sc_billed_quantity,
    sdt.sc_nr_value,
    sdt.sc_achievement_nr,
    sdt.sc_achievement_amt,
    sdt.sc_gross_amt,
    sdt.sc_net_amt,
    sdt.sc_prd_disc_sch_amt,
    sdt.latest_customer_code,
    sch.claimable
FROM (
    (
        SELECT sch.fisc_yr,
            sch.qtr,
            sch.mth_yyyymm,
            sch.rtruniquecode,
            sch.retailer_name,
            sch.region_name,
            sch.zone_name,
            sch.territory_name,
            sch.state_name,
            sch.town_name,
            sch.business_channel,
            sch.channel_name,
            sch.class_desc,
            sch.billedprdccode,
            sch.billedprdbatcode,
            sch.product_name,
            sch.franchise_name,
            sch.brand_name,
            sch.product_category_name,
            sch.variant_name,
            sch.mothersku_name,
            sch.schemecode,
            sch.schemedescription,
            sch.schtype,
            sch.schemetype,
            sch.companyschemecode,
            sch.schemetype1,
            sch.schemetype2,
            sch.schvaluetype,
            sch.schemefreeproduct,
            sch.claimable,
            sum(sch.schemeutilizedamt) AS sch_schemeutilizedamt,
            sum(sch.schemeutilizedqty) AS sch_schemeutilizedqty,
            sum(sch.billedqty) AS sch_billedqty,
            sum(sch.schdiscperc) AS sch_schdiscperc,
            sum(sch.billedrate) AS sch_billedrate
        FROM edw_rpt_schemeutilize_cube sch
        WHERE (sch.fisc_yr >= 2022)
        GROUP BY sch.fisc_yr,
            sch.qtr,
            sch.mth_yyyymm,
            sch.rtruniquecode,
            sch.retailer_name,
            sch.region_name,
            sch.zone_name,
            sch.territory_name,
            sch.state_name,
            sch.town_name,
            sch.business_channel,
            sch.channel_name,
            sch.class_desc,
            sch.billedprdccode,
            sch.billedprdbatcode,
            sch.product_name,
            sch.franchise_name,
            sch.brand_name,
            sch.product_category_name,
            sch.variant_name,
            sch.mothersku_name,
            sch.schemecode,
            sch.schemedescription,
            sch.schtype,
            sch.schemetype,
            sch.companyschemecode,
            sch.schemetype1,
            sch.schemetype2,
            sch.schvaluetype,
            sch.schemefreeproduct,
            sch.claimable
        
        UNION ALL
        
        SELECT sch.fisc_yr,
            sch.qtr,
            sch.mth_yyyymm,
            sch.rtruniquecode,
            sch.retailer_name,
            sch.region_name,
            sch.zone_name,
            sch.territory_name,
            sch.state_name,
            sch.town_name,
            sch.business_channel,
            sch.channel_name,
            sch.class_desc,
            sch.billedprdccode,
            sch.billedprdbatcode,
            sch.product_name,
            sch.franchise_name,
            sch.brand_name,
            sch.product_category_name,
            sch.variant_name,
            sch.mothersku_name,
            sch.schemecode,
            sch.schemedescription,
            sch.schtype,
            sch.schemetype,
            sch.companyschemecode,
            sch.schemetype1,
            sch.schemetype2,
            sch.schvaluetype,
            sch.schemefreeproduct,
            sch.claimable,
            sum(sch.schemeutilizedamt) AS sch_schemeutilizedamt,
            sum(sch.schemeutilizedqty) AS sch_schemeutilizedqty,
            sum(sch.billedqty) AS sch_billedqty,
            sum(sch.schdiscperc) AS sch_schdiscperc,
            sum(sch.billedrate) AS sch_billedrate
        FROM edw_rpt_schemeutilize_cube_2020_2021 sch
        WHERE (sch.fisc_yr >= 2020)
        GROUP BY sch.fisc_yr,
            sch.qtr,
            sch.mth_yyyymm,
            sch.rtruniquecode,
            sch.retailer_name,
            sch.region_name,
            sch.zone_name,
            sch.territory_name,
            sch.state_name,
            sch.town_name,
            sch.business_channel,
            sch.channel_name,
            sch.class_desc,
            sch.billedprdccode,
            sch.billedprdbatcode,
            sch.product_name,
            sch.franchise_name,
            sch.brand_name,
            sch.product_category_name,
            sch.variant_name,
            sch.mothersku_name,
            sch.schemecode,
            sch.schemedescription,
            sch.schtype,
            sch.schemetype,
            sch.companyschemecode,
            sch.schemetype1,
            sch.schemetype2,
            sch.schvaluetype,
            sch.schemefreeproduct,
            sch.claimable
        ) sch LEFT JOIN (
        SELECT v_rpt_sales_details_with_history.mth_mm,
            v_rpt_sales_details_with_history.rtruniquecode,
            v_rpt_sales_details_with_history.latest_customer_code,
            v_rpt_sales_details_with_history.mothersku_name,
            sum(v_rpt_sales_details_with_history.quantity) AS sc_billed_quantity,
            sum(v_rpt_sales_details_with_history.nr_value) AS sc_nr_value,
            sum(v_rpt_sales_details_with_history.achievement_nr) AS sc_achievement_nr,
            sum(v_rpt_sales_details_with_history.achievement_amt) AS sc_achievement_amt,
            sum(v_rpt_sales_details_with_history.gross_amt) AS sc_gross_amt,
            sum(v_rpt_sales_details_with_history.net_amt) AS sc_net_amt,
            sum(v_rpt_sales_details_with_history.prd_disc_sch_amt) AS sc_prd_disc_sch_amt
        FROM v_rpt_sales_details_with_history
        WHERE (v_rpt_sales_details_with_history.mth_mm >= 2020)
        GROUP BY v_rpt_sales_details_with_history.mth_mm,
            v_rpt_sales_details_with_history.rtruniquecode,
            v_rpt_sales_details_with_history.latest_customer_code,
            v_rpt_sales_details_with_history.mothersku_name
        ) sdt ON (
            (
                (
                    (
                        CASE 
                            WHEN (sch.mth_yyyymm >= 10)
                                THEN (((sch.fisc_yr)::CHARACTER VARYING)::TEXT || ((sch.mth_yyyymm)::CHARACTER VARYING)::TEXT)
                            ELSE ((((sch.fisc_yr)::CHARACTER VARYING)::TEXT || ((0)::CHARACTER VARYING)::TEXT) || ((sch.mth_yyyymm)::CHARACTER VARYING)::TEXT)
                            END = ((sdt.mth_mm)::CHARACTER VARYING)::TEXT
                        )
                    AND ((sch.rtruniquecode)::TEXT = (sdt.rtruniquecode)::TEXT)
                    )
                AND (upper((sch.mothersku_name)::TEXT) = upper((sdt.mothersku_name)::TEXT))
                )
            )
    )
),

final as (
    select 
        year::number(18,0) as year,
        quarter::number(18,0) as quarter,
        month::number(18,0) as month,
        rtruniquecode::varchar(100) as rtruniquecode,
        retailer_name::varchar(150) as retailer_name,
        region_name::varchar(50) as region_name,
        zone_name::varchar(50) as zone_name,
        territory_name::varchar(50) as territory_name,
        state_name::varchar(50) as state_name,
        town_name::varchar(50) as town_name,
        business_channel::varchar(50) as business_channel,
        channel_name::varchar(150) as channel_name,
        class_desc::varchar(50) as class_desc,
        billedprdccode::varchar(100) as billedprdccode,
        billedprdbatcode::varchar(100) as billedprdbatcode,
        product_name::varchar(50) as product_name,
        franchise_name::varchar(50) as franchise_name,
        brand_name::varchar(50) as brand_name,
        product_category_name::varchar(150) as product_category_name,
        variant_name::varchar(150) as variant_name,
        mothersku_name::varchar(150) as mothersku_name,
        schemecode::varchar(50) as schemecode,
        schemedescription::varchar(200) as schemedescription,
        schtype::varchar(10) as schtype,
        schemetype::varchar(50) as schemetype,
        companyschemecode::varchar(50) as companyschemecode,
        schemetype1::varchar(50) as schemetype1,
        schemetype2::varchar(50) as schemetype2,
        schvaluetype::varchar(100) as schvaluetype,
        schemefreeproduct::varchar(50) as schemefreeproduct,
        sch_schemeutilizedamt::number(38,6) as sch_schemeutilizedamt,
        sch_schemeutilizedqty::number(38,0) as sch_schemeutilizedqty,
        sch_billedqty::number(38,0) as sch_billedqty,
        sch_schdiscperc::number(38,6) as sch_schdiscperc,
        sch_billedrate::number(38,6) as sch_billedrate,
        sc_billed_quantity::number(38,0) as sc_billed_quantity,
        sc_nr_value::number(38,6) as sc_nr_value,
        sc_achievement_nr::number(38,6) as sc_achievement_nr,
        sc_achievement_amt::number(38,6) as sc_achievement_amt,
        sc_gross_amt::number(38,6) as sc_gross_amt,
        sc_net_amt::number(38,6) as sc_net_amt,
        sc_prd_disc_sch_amt::number(38,6) as sc_prd_disc_sch_amt,
        latest_customer_code::varchar(50) as latest_customer_code,
        claimable::varchar(7) as claimable
    from result
)

select * from final