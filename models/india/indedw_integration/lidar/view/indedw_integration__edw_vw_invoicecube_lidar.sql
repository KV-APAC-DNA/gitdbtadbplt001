with edw_billing_fact as (
    select * from {{ ref('aspedw_integration__edw_billing_fact') }}
),

edw_retailer_calendar_dim as (
    select * from {{ ref('indedw_integration__edw_retailer_calendar_dim') }}
),

v_rpt_cust_mast_inv_tde as (
    select * from {{ ref('indedw_integration__v_rpt_cust_mast_inv_tde') }}
),

edw_product_dim as (
    select * from {{ ref('indedw_integration__edw_product_dim') }}
),

result as (
SELECT cal.mth_mm,
    cal.fisc_yr AS year,
    cal.mth_yyyymm AS month,
    cal.qtr AS quarter,
    cal.week,
    bf.bill_num,
    bf.bill_item,
    bf.bill_dt,
    bf.bill_type,
    bf.sold_to,
    bf.rt_promo,
    bf.s_ord_item,
    bf.doc_num,
    bf.grs_wgt_dl,
    bf.inv_qty,
    bf.bill_qty,
    bf.base_uom,
    bf.exchg_rate,
    bf.req_qty,
    bf.sls_unit,
    bf.payer,
    bf.rebate_bas,
    bf.no_inv_it,
    bf.subtotal_1,
    bf.subtotal_3,
    bf.subtotal_4,
    bf.subtotal_2,
    bf.netval_inv,
    bf.exchg_stat,
    bf.zblqtycse,
    bf.exratexacc,
    bf.subtotal_6,
    bf.gross_val,
    bf.unit_of_wt,
    bf.subtotal_5,
    bf.numerator,
    bf.cost,
    bf.plant,
    bf.volume_dl,
    bf.loc_currcy,
    bf.denomintr,
    bf.volume_unit,
    bf.scale_qty,
    bf.cshdsc_bas,
    bf.net_wgt_dl,
    bf.tax_amt,
    bf.rate_type,
    bf.sls_org,
    bf.exrate_acc,
    bf.distr_chnl,
    bf.doc_currcy,
    bf.co_area,
    bf.doc_categ,
    bf.fisc_varnt,
    bf.cost_center,
    bf.matl_group,
    bf.division,
    bf.material,
    bf.sls_grp,
    bf.div_head,
    bf.ship_point,
    bf.wbs_elemt,
    bf.bill_rule,
    bf.bwapplnm,
    bf.process_key,
    bf.cust_grp,
    bf.sls_off,
    bf.refer_itm,
    bf.matl_grp_3,
    bf.price_dt,
    bf.sls_emply,
    bf.refer_doc,
    bf.st_up_dte,
    bf.stat_date,
    bf.item_categ,
    bf.prov_grp,
    bf.matl_grp_5,
    bf.prod_hier,
    bf.itm_type,
    bf.matl_grp_4,
    bf.ship_to,
    bf.bill_to_prty,
    bf.rebate_grp,
    bf.matl_grp_2,
    bf.matl_grp_1,
    bf.eanupc,
    bf.mat_entrd,
    bf.batch,
    bf.stor_loc,
    bf.created_on,
    bf.serv_date,
    bf.cust_grp5,
    bf.sls_deal,
    bf.bill_cat,
    bf.cust_grp1,
    bf.cust_grp3,
    bf.trans_dt,
    bf.cust_grp4,
    bf.cust_grp2,
    bf.stat_curr,
    bf.ch_on,
    bf.comp_cd,
    bf.sls_dist,
    bf.stor_no,
    bf.record_mode,
    bf.customer,
    bf.cust_sls,
    bf.oi_ebeln,
    bf.oi_ebelp,
    bf.zsd_pod,
    bf.cdl_dttm,
    bf.crtd_dttm,
    bf.updt_dttm,
    cm.customer_name,
    cm.customer_code,
    cm.region_name,
    cm.zone_name,
    cm.territory_name,
    cm.state_name,
    cm.town_name,
    cm.city,
    cm.type_code,
    cm.type_name,
    cm.active_flag AS customer_active_flag,
    pd.product_name,
    pd.franchise_name,
    pd.brand_name,
    pd.product_category_name,
    pd.variant_name,
    pd.mothersku_name
FROM edw_billing_fact bf
JOIN edw_retailer_calendar_dim cal ON ((to_char((bf.created_on)::TIMESTAMP without TIME zone, 'YYYYMMDD'::TEXT) = (cal.day)::TEXT))
LEFT JOIN v_rpt_cust_mast_inv_tde cm ON (
        (
            "right" (
                (bf.sold_to)::TEXT,
                6
                ) = (cm.customer_code)::TEXT
            )
        )
LEFT JOIN edw_product_dim pd ON ((ltrim((bf.material)::TEXT, (0)::TEXT) = (pd.product_code)::TEXT))
WHERE (cal.fisc_yr >= 2021)
),

final as (
    select 
        mth_mm::number(18,0) as mth_mm,
        year::number(18,0) as year,
        month::number(18,0) as month,
        quarter::number(18,0) as quarter,
        week::number(18,0) as week,
        bill_num::varchar(50) as bill_num,
        bill_item::varchar(50) as bill_item,
        bill_dt::date as bill_dt,
        bill_type::varchar(30) as bill_type,
        sold_to::varchar(50) as sold_to,
        rt_promo::varchar(100) as rt_promo,
        s_ord_item::varchar(50) as s_ord_item,
        doc_num::varchar(50) as doc_num,
        grs_wgt_dl::number(20,4) as grs_wgt_dl,
        inv_qty::number(20,4) as inv_qty,
        bill_qty::number(20,4) as bill_qty,
        base_uom::varchar(30) as base_uom,
        exchg_rate::number(20,4) as exchg_rate,
        req_qty::number(20,4) as req_qty,
        sls_unit::varchar(20) as sls_unit,
        payer::varchar(50) as payer,
        rebate_bas::number(20,4) as rebate_bas,
        no_inv_it::number(20,4) as no_inv_it,
        subtotal_1::number(20,4) as subtotal_1,
        subtotal_3::number(20,4) as subtotal_3,
        subtotal_4::number(20,4) as subtotal_4,
        subtotal_2::number(20,4) as subtotal_2,
        netval_inv::number(20,4) as netval_inv,
        exchg_stat::number(20,4) as exchg_stat,
        zblqtycse::number(20,4) as zblqtycse,
        exratexacc::number(20,4) as exratexacc,
        subtotal_6::number(20,4) as subtotal_6,
        gross_val::number(20,4) as gross_val,
        unit_of_wt::varchar(20) as unit_of_wt,
        subtotal_5::number(20,4) as subtotal_5,
        numerator::number(20,4) as numerator,
        cost::number(20,4) as cost,
        plant::varchar(30) as plant,
        volume_dl::number(20,4) as volume_dl,
        loc_currcy::varchar(30) as loc_currcy,
        denomintr::number(20,4) as denomintr,
        volume_unit::varchar(20) as volume_unit,
        scale_qty::varchar(20) as scale_qty,
        cshdsc_bas::number(20,4) as cshdsc_bas,
        net_wgt_dl::number(20,4) as net_wgt_dl,
        tax_amt::number(20,4) as tax_amt,
        rate_type::varchar(30) as rate_type,
        sls_org::varchar(20) as sls_org,
        exrate_acc::number(20,4) as exrate_acc,
        distr_chnl::varchar(30) as distr_chnl,
        doc_currcy::varchar(30) as doc_currcy,
        co_area::varchar(30) as co_area,
        doc_categ::varchar(20) as doc_categ,
        fisc_varnt::varchar(20) as fisc_varnt,
        cost_center::varchar(100) as cost_center,
        matl_group::varchar(30) as matl_group,
        division::varchar(30) as division,
        material::varchar(50) as material,
        sls_grp::varchar(30) as sls_grp,
        div_head::varchar(100) as div_head,
        ship_point::varchar(50) as ship_point,
        wbs_elemt::varchar(100) as wbs_elemt,
        bill_rule::varchar(100) as bill_rule,
        bwapplnm::varchar(30) as bwapplnm,
        process_key::varchar(50) as process_key,
        cust_grp::varchar(50) as cust_grp,
        sls_off::varchar(50) as sls_off,
        refer_itm::varchar(50) as refer_itm,
        matl_grp_3::varchar(50) as matl_grp_3,
        price_dt::date as price_dt,
        sls_emply::varchar(100) as sls_emply,
        refer_doc::varchar(100) as refer_doc,
        st_up_dte::date as st_up_dte,
        stat_date::varchar(100) as stat_date,
        item_categ::varchar(100) as item_categ,
        prov_grp::varchar(50) as prov_grp,
        matl_grp_5::varchar(50) as matl_grp_5,
        prod_hier::varchar(100) as prod_hier,
        itm_type::varchar(50) as itm_type,
        matl_grp_4::varchar(30) as matl_grp_4,
        ship_to::varchar(50) as ship_to,
        bill_to_prty::varchar(50) as bill_to_prty,
        rebate_grp::varchar(50) as rebate_grp,
        matl_grp_2::varchar(30) as matl_grp_2,
        matl_grp_1::varchar(30) as matl_grp_1,
        eanupc::varchar(50) as eanupc,
        mat_entrd::varchar(50) as mat_entrd,
        batch::varchar(100) as batch,
        stor_loc::varchar(50) as stor_loc,
        created_on::date as created_on,
        serv_date::date as serv_date,
        cust_grp5::varchar(100) as cust_grp5,
        sls_deal::varchar(100) as sls_deal,
        bill_cat::varchar(100) as bill_cat,
        cust_grp1::varchar(100) as cust_grp1,
        cust_grp3::varchar(100) as cust_grp3,
        trans_dt::date as trans_dt,
        cust_grp4::varchar(100) as cust_grp4,
        cust_grp2::varchar(100) as cust_grp2,
        stat_curr::varchar(50) as stat_curr,
        ch_on::varchar(50) as ch_on,
        comp_cd::varchar(50) as comp_cd,
        sls_dist::varchar(50) as sls_dist,
        stor_no::varchar(100) as stor_no,
        record_mode::varchar(20) as record_mode,
        customer::varchar(50) as customer,
        cust_sls::varchar(50) as cust_sls,
        oi_ebeln::varchar(100) as oi_ebeln,
        oi_ebelp::varchar(100) as oi_ebelp,
        zsd_pod::varchar(100) as zsd_pod,
        cdl_dttm::varchar(255) as cdl_dttm,
        crtd_dttm::timestamp_ntz(9) as crtd_dttm,
        updt_dttm::timestamp_ntz(9) as updt_dttm,
        customer_name::varchar(500) as customer_name,
        customer_code::varchar(500) as customer_code,
        region_name::varchar(500) as region_name,
        zone_name::varchar(500) as zone_name,
        territory_name::varchar(500) as territory_name,
        state_name::varchar(50) as state_name,
        town_name::varchar(50) as town_name,
        city::varchar(150) as city,
        type_code::number(18,0) as type_code,
        type_name::varchar(500) as type_name,
        customer_active_flag::varchar(7) as customer_active_flag,
        product_name::varchar(50) as product_name,
        franchise_name::varchar(50) as franchise_name,
        brand_name::varchar(50) as brand_name,
        product_category_name::varchar(150) as product_category_name,
        variant_name::varchar(150) as variant_name,
        mothersku_name::varchar(150) as mothersku_name
    from result
)

select * from final