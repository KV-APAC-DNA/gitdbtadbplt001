{{
    config(
        materialized= "incremental",
        incremental_strategy= "append",
        pre_hook = "{% if is_incremental() %}
                delete from {{this}}
                where (sample_transaction_id) in (select sample_transaction_id
                from {{ source('hcposesdl_raw', 'sdl_hcp_osea_sample_transaction') }} stg_osea_transaction
                where stg_osea_transaction.sample_transaction_id = sample_transaction_id);
                {% endif %}"
    )
}}
with sdl_hcp_osea_sample_transaction
as
(
select * from {{ source('hcposesdl_raw', 'sdl_hcp_osea_sample_transaction') }}
)
,
transformed as
(
    select
    SAMPLE_TRANSACTION_ID,
(CASE WHEN UPPER(IS_DELETED) = 'TRUE' THEN 1 WHEN UPPER(IS_DELETED) IS NULL THEN 0 WHEN UPPER(IS_DELETED) = ' ' 
 THEN 0 ELSE 0 END) AS IS_DELETED,
TRANSACTION_NAME,
RECORD_TYPE_ID,
CREATED_DATE,
CREATED_BY_ID,
LAST_MODIFIED_DATE,
LAST_MODIFIED_BY_ID,
SYSTEM_MODSTAMP,
MAY_EDIT,
CASE WHEN UPPER(IS_LOCKED) = 'TRUE' THEN 1 WHEN UPPER(IS_LOCKED) = 'FALSE' THEN 0 ELSE 0 END AS IS_LOCKED,
LAST_VIEWED_DATE,
LAST_REFERENCED_DATE,
INVENTORY_IMPACT_QUANTITY,
LOT_ID,
DISCREPANCY,
ADJUST_FOR,
TRANSFER_TO_NAME,
SIGNATURE,
RECEIVED,
SIGNATURE_DATE,
TRANSFERRED_FROM,
CALL_NAME,
RECEIPT_COMMENTS,
TRANSFERRED_DATE,
SUBMITTED_DATE,
TRANSFER_TO,
SHIPMENT_ID,
ADDRESS_LINE_1,
ZIP,
STATUS,
CITY,
ADJUSTED_DATE,
CONFIRMED_QUANTITY,
U_M,
DISCLAIMER,
DISBURSED_TO,
REF_TRANSACTION_ID,
COMMENTS,
SAMPLE_NAME,
UNLOCK,
QUANTITY,
TRANSFERRED_FROM_NAME,
TYPE,
LOT_ID_NAME,
REASON,
GROUP_TRANSACTION_ID_VOD,
ZVOD_SAMPLE_LINES_VOD,
ADDRESS_LINE_2,
STATE,
RETURN_TO,
SAMPLE_CARD_ID,
ASSMCA,
ACCOUNT,
CALL_DATE,
CALL_DATETIME,
DEA_EXPIRATION_DATE,
DEA_ID,
SAMPLE_CARD_REASON,
ZIP_4,
LICENSE_ID,
REQUEST_RECEIPT,
GROUP_IDENTIFIER,
CREDENTIALS,
SALUTATION,
MANUFACTURER,
DISTRIBUTOR,
COUNTRY_CODE,
LEGACY_ID,
current_timestamp() as INSERTED_DATE,
       NULL as UPDATED_DATE 
from sdl_hcp_osea_sample_transaction
)
,
final as
(select 
	SAMPLE_TRANSACTION_ID::VARCHAR(18) AS SAMPLE_TRANSACTION_ID,
IS_DELETED::NUMBER(38,0) AS IS_DELETED,
TRANSACTION_NAME::VARCHAR(30) AS TRANSACTION_NAME,
RECORD_TYPE_ID::VARCHAR(50) AS RECORD_TYPE_ID,
CREATED_DATE::TIMESTAMP_NTZ(9) AS CREATED_DATE,
CREATED_BY_ID::VARCHAR(18) AS CREATED_BY_ID,
LAST_MODIFIED_DATE::TIMESTAMP_NTZ(9) AS LAST_MODIFIED_DATE,
LAST_MODIFIED_BY_ID::VARCHAR(18) AS LAST_MODIFIED_BY_ID,
SYSTEM_MODSTAMP::TIMESTAMP_NTZ(9) AS SYSTEM_MODSTAMP,
MAY_EDIT::VARCHAR(10) AS MAY_EDIT,
IS_LOCKED::NUMBER(38,0) AS IS_LOCKED,
LAST_VIEWED_DATE::TIMESTAMP_NTZ(9) AS LAST_VIEWED_DATE,
LAST_REFERENCED_DATE::TIMESTAMP_NTZ(9) AS LAST_REFERENCED_DATE,
INVENTORY_IMPACT_QUANTITY::NUMBER(18,0) AS INVENTORY_IMPACT_QUANTITY,
LOT_ID::VARCHAR(50) AS LOT_ID,
DISCREPANCY::NUMBER(18,0) AS DISCREPANCY,
ADJUST_FOR::VARCHAR(50) AS ADJUST_FOR,
TRANSFER_TO_NAME::VARCHAR(255) AS TRANSFER_TO_NAME,
SIGNATURE::VARCHAR(32000) AS SIGNATURE,
RECEIVED::VARCHAR(50) AS RECEIVED,
SIGNATURE_DATE::TIMESTAMP_NTZ(9) AS SIGNATURE_DATE,
TRANSFERRED_FROM::VARCHAR(100) AS TRANSFERRED_FROM,
CALL_NAME::VARCHAR(100) AS CALL_NAME,
RECEIPT_COMMENTS::VARCHAR(255) AS RECEIPT_COMMENTS,
TRANSFERRED_DATE::DATE AS TRANSFERRED_DATE,
SUBMITTED_DATE::DATE AS SUBMITTED_DATE,
TRANSFER_TO::VARCHAR(100) AS TRANSFER_TO,
SHIPMENT_ID::VARCHAR(50) AS SHIPMENT_ID,
ADDRESS_LINE_1::VARCHAR(80) AS ADDRESS_LINE_1,
ZIP::VARCHAR(6) AS ZIP,
STATUS::VARCHAR(50) AS STATUS,
CITY::VARCHAR(40) AS CITY,
ADJUSTED_DATE::DATE AS ADJUSTED_DATE,
CONFIRMED_QUANTITY::NUMBER(18,0) AS CONFIRMED_QUANTITY,
U_M::VARCHAR(50) AS U_M,
DISCLAIMER::VARCHAR(1000) AS DISCLAIMER,
DISBURSED_TO::VARCHAR(2000) AS DISBURSED_TO,
REF_TRANSACTION_ID::VARCHAR(100) AS REF_TRANSACTION_ID,
COMMENTS::VARCHAR(255) AS COMMENTS,
SAMPLE_NAME::VARCHAR(100) AS SAMPLE_NAME,
UNLOCK::VARCHAR(50) AS UNLOCK,
QUANTITY::NUMBER(18,0) AS QUANTITY,
TRANSFERRED_FROM_NAME::VARCHAR(255) AS TRANSFERRED_FROM_NAME,
TYPE::VARCHAR(50) AS TYPE,
LOT_ID_NAME::VARCHAR(80) AS LOT_ID_NAME,
REASON::VARCHAR(50) AS REASON,
GROUP_TRANSACTION_ID_VOD::VARCHAR(255) AS GROUP_TRANSACTION_ID_VOD,
ZVOD_SAMPLE_LINES_VOD::VARCHAR(100) AS ZVOD_SAMPLE_LINES_VOD,
ADDRESS_LINE_2::VARCHAR(100) AS ADDRESS_LINE_2,
STATE::VARCHAR(50) AS STATE,
RETURN_TO::VARCHAR(50) AS RETURN_TO,
SAMPLE_CARD_ID::VARCHAR(15) AS SAMPLE_CARD_ID,
ASSMCA::VARCHAR(100) AS ASSMCA,
ACCOUNT::VARCHAR(100) AS ACCOUNT,
CALL_DATE::DATE AS CALL_DATE,
CALL_DATETIME::TIMESTAMP_NTZ(9) AS CALL_DATETIME,
DEA_EXPIRATION_DATE::DATE AS DEA_EXPIRATION_DATE,
DEA_ID::VARCHAR(9) AS DEA_ID,
SAMPLE_CARD_REASON::VARCHAR(50) AS SAMPLE_CARD_REASON,
ZIP_4::VARCHAR(40) AS ZIP_4,
LICENSE_ID::VARCHAR(25) AS LICENSE_ID,
REQUEST_RECEIPT::VARCHAR(100) AS REQUEST_RECEIPT,
GROUP_IDENTIFIER::VARCHAR(1300) AS GROUP_IDENTIFIER,
CREDENTIALS::VARCHAR(255) AS CREDENTIALS,
SALUTATION::VARCHAR(255) AS SALUTATION,
MANUFACTURER::VARCHAR(255) AS MANUFACTURER,
DISTRIBUTOR::VARCHAR(255) AS DISTRIBUTOR,
COUNTRY_CODE::VARCHAR(3) AS COUNTRY_CODE,
LEGACY_ID::VARCHAR(255) AS LEGACY_ID,
	inserted_date::timestamp_ntz(9) as inserted_date,
	updated_date::timestamp_ntz(9) as updated_date
	from transformed
)

select * from final 
