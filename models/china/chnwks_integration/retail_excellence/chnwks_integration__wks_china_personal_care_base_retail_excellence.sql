--import cte
with edw_rpt_regional_sellout_offtake as (
    select * from {{ source('aspedw_integration', 'edw_rpt_regional_sellout_offtake') }}
),
edw_vw_cal_retail_excellence_dim as (
    select * from {{ source('aspedw_integration', 'edw_vw_cal_retail_excellence_dim') }}
),
cnpc_regional_sellout_mapped_sku_cd as (
    select * from {{ ref('chnwks_integration__wks_china_personal_care_regional_sellout_mapped_sku_cd') }}
),
cnpc_regional_sellout_ean as (
    select * from {{ ref('chnwks_integration__wks_china_personal_care_regional_sellout_ean') }}
),

cnpc_base_retail_excellence
as
(
select  country_code as cntry_cd,
md5(nvl(soldto_code,'sd')||nvl (distributor_code,'dc') ||nvl (store_code,'sc') ||nvl (distributor_name,'dn')||nvl (zone,'zone')||nvl (city,'city')||
nvl (ean,'ean') ||
nvl (product_code,'prdcd')||
nvl (mapped_sku_code,'sku')
||
nvl (store_type,'st') || nvl (store_name,'sn')||nvl (sap_parent_customer_key,'spck') ||nvl (sap_parent_customer_description,'spscd')
|| nvl (sap_customer_channel_key,'scck') ||nvl (sap_customer_channel_description,'sccd') ||nvl (sap_customer_sub_channel_key,'scsck') ||nvl (sap_sub_channel_description,'sscd')
||nvl (customer_segment_key,'csk') ||nvl (customer_segment_description,'csd') || nvl (sap_go_to_mdl_key,'sgmk') ||nvl (sap_go_to_mdl_description,'sgmd') ||nvl (sap_banner_key,'sbk')
||nvl (sap_banner_description,'sbd') ||nvl (sap_banner_format_key,'sbfk') ||nvl (sap_banner_format_description,'sbfd') ||nvl (retail_environment,'re')
|| nvl (global_product_franchise,'gpf') ||nvl (global_product_brand,'gpb') ||nvl (global_product_sub_brand,'gpsb') || nvl (global_product_variant,'gpv')
||nvl (global_product_segment,'gps') ||nvl (global_product_subsegment,'gpss') || nvl (global_product_category,'gpc') ||nvl (global_product_subcategory,'gpsc')
||nvl (global_put_up_description,'gpud') ||nvl (pka_product_key,'pk')||nvl (region,'rg')||nvl (zone,'zone')||nvl(pka_product_key_desc,'pkd')) as sellout_dim_key,
country_name as cntry_nm,
data_source as data_src,
soldto_code,
distributor_code,
ean,
product_code,
distributor_name,
store_code,
store_type,
store_name,
--ean_code,
mapped_sku_code,
msl_product_desc,
year,
mnth_id,
--customer_product_desc,
sap_parent_customer_key,
sap_parent_customer_description,
sap_customer_channel_key,
sap_customer_channel_description,
sap_customer_sub_channel_key,
sap_sub_channel_description,
sap_go_to_mdl_key,
sap_go_to_mdl_description,
sap_banner_key,
sap_banner_description,
sap_banner_format_key,
sap_banner_format_description,
retail_environment,
region,
zone,
city,
customer_segment_key,
customer_segment_description,
global_product_franchise,
global_product_brand,
global_product_sub_brand,
global_product_variant,
global_product_segment,
global_product_subsegment,
global_product_category,
global_product_subcategory,
global_put_up_description,
pka_product_key,
pka_product_key_desc,
sum(sellout_sales_quantity) as sls_qty,
sum(sellout_sales_value) as sls_value,
cast(avg(sellout_sales_quantity) as numeric(38,6)) as avg_qty,
sum(sales_value_list_price)as sales_value_list_price,
sysdate() as crt_dttm
from (select country_code,
country_name,
--sd.soldto_code as soldto_code,
soldto_code,
distributor_name||'#'||ltrim(distributor_code,'0') as distributor_name,
distributor_code,
store_code,
--main.ean,
//changes below to map mother code
--case when main.mother_code != 'NA' and main.mother_code is not null then main.mother_code else main.ean   
--end as product_code,
nv(main.mother_code,'NA') as product_code,
store_type,
main.store_name||'#'||ltrim(main.store_code,'0') as store_name,
--
-----add latest ean by mother_code as well---
case when main.mother_code = 'NA' or main.mother_code is null then main.ean else ed.ean end as ean,
--case when ean != 'na' and ean is not null then pd.sku_code else sku_code end as mapped_sku_code,
pd.sku_code as mapped_sku_code,
--case when main.mother_code = 'na' then pd.msl_product_desc else ed.msl_product_desc as msl_product_desc
--case when ean != 'na' and ean is not null then pd.msl_product_desc else msl_product_desc end as msl_product_desc,
pd.msl_product_desc as msl_product_desc,
data_source,
year,
mnth_id,
sap_parent_customer_key,
sap_parent_customer_description,
sap_customer_channel_key,
sap_customer_channel_description,
sap_customer_sub_channel_key,
sap_sub_channel_description,
sap_go_to_mdl_key,
sap_go_to_mdl_description,
sap_banner_key,
sap_banner_description,
sap_banner_format_key,
sap_banner_format_description,
retail_environment,
region,
zone,
city,
customer_segment_key,
customer_segment_description,
global_product_franchise,
global_product_brand,global_product_sub_brand,
global_product_variant,
global_product_segment,
global_product_subsegment,
global_product_category,
global_product_subcategory,
global_put_up_description,
pka_product_key,
pka_product_key_desc,
sellout_sales_quantity,
sellout_sales_value,
sales_value_list_price
from (select country_code,
country_name,
--max(soldto_code) over (partition by distributor_code order by length(soldto_code) desc,cal_date desc rows between unbounded preceding and --unbounded following) as soldto_code,
soldto_code,
--sd.soldto_code as soldto_code,
max(distributor_name) over (partition by distributor_code order by cal_date desc rows between unbounded preceding and unbounded following) as distributor_name,
distributor_code,
--ltrim(msl_product_code,'0') as ean,
 msl_product_code as mother_code,
store_code,
upper(store_type) as store_type,
max(store_name) over (partition by store_code order by cal_date desc rows between unbounded preceding and unbounded following) as store_name,
ean,
--sku_code,
msl_product_desc,
--pd.sku_code as mapped_sku_code,
data_source,
year as year,
mnth_id as mnth_id,
--customer_product_desc,
sap_parent_customer_key,
sap_parent_customer_description,
sap_customer_channel_key,
sap_customer_channel_description,
sap_customer_sub_channel_key,
sap_sub_channel_description,
sap_go_to_mdl_key,
sap_go_to_mdl_description,
sap_banner_key,
sap_banner_description,
sap_banner_format_key,
sap_banner_format_description,
retail_environment,
region,
zone_or_area as zone,
distributor_additional_attribute2 as city,
customer_segment_key,
customer_segment_description,
global_product_franchise,
global_product_brand,
global_product_sub_brand,
global_product_variant,
global_product_segment,
global_product_subsegment,
global_product_category,
global_product_subcategory,
global_put_up_description,
pka_product_key,
upper(pka_product_key_description) as pka_product_key_desc,
sellout_sales_quantity,
sellout_sales_value,
sellout_value_list_price as sales_value_list_price
from edw_rpt_regional_sellout_offtake
where country_name = 'China Personal Care'
and   data_source in ('SELL-OUT','POS')
and mnth_id >= (select last_28mnths from edw_vw_cal_retail_excellence_dim)::numeric
						   and mnth_id <= (select last_2mnths from edw_vw_cal_retail_excellence_dim)::numeric  
)main
left join cnpc_regional_sellout_ean ed
on upper(main.mother_code) = ed.mother_code
left join cnpc_regional_sellout_mapped_sku_cd pd
on case when main.mother_code = 'NA' then upper(main.ean) else ed.ean end = pd.ean
)

group by country_code,
country_name,
data_source,
year,
mnth_id,
soldto_code,
distributor_code,
ean,
product_code,
distributor_name,
store_code,
store_name,
store_type,
city,
--customer_product_desc,
sap_parent_customer_key,
sap_parent_customer_description,
sap_customer_channel_key,
sap_customer_channel_description,
sap_customer_sub_channel_key,
sap_sub_channel_description,
sap_go_to_mdl_key,
sap_go_to_mdl_description,
sap_banner_key,
sap_banner_description,
sap_banner_format_key,
sap_banner_format_description,
retail_environment,
region,
zone,
customer_segment_key,
customer_segment_description,
global_product_franchise,
global_product_brand,
global_product_sub_brand,
global_product_variant,
global_product_segment,
global_product_subsegment,
global_product_category,
global_product_subcategory,
global_put_up_description,
--ean_code,
mapped_sku_code,
msl_product_desc,
--sku_description
pka_product_key,
pka_product_key_desc
),

final as 
(
select cntry_cd::varchar(2) as cntry_cd,
       sellout_dim_key::varchar(32) as sellout_dim_key,
       cntry_nm::varchar(50) as cntry_nm,
       data_src::varchar(14) as data_src,
       soldto_code::varchar(255) as soldto_code,
       distributor_code::varchar(100) as distributor_code,
       ean::varchar(150) as ean,
       product_code::varchar(356) as product_code,
       distributor_name::varchar(100) as distributor_name,
       store_code::varchar(100) as store_code,
       store_type::varchar(382) as store_type,
       store_name::varchar(601) as store_name,
       mapped_sku_code::varchar(40) as mapped_sku_code,
       msl_product_desc::varchar(300) as msl_product_desc,
	   year::numeric(18,0) as year,	
	   mnth_id::varchar(23) as mnth_id,
       sap_parent_customer_key::varchar(12) as sap_parent_customer_key,
       sap_parent_customer_description::varchar(75) as sap_parent_customer_description,
       sap_customer_channel_key::varchar(12) as sap_customer_channel_key,
       sap_customer_channel_description::varchar(75) as sap_customer_channel_description,
       sap_customer_sub_channel_key::varchar(12) as sap_customer_sub_channel_key,
       sap_sub_channel_description::varchar(75) as sap_sub_channel_description ,
       sap_go_to_mdl_key::varchar(12) as sap_go_to_mdl_key,
       sap_go_to_mdl_description::varchar(75) as sap_go_to_mdl_description,
       sap_banner_key::varchar(12) as sap_banner_key,
       sap_banner_description::varchar(75) as sap_banner_description,
       sap_banner_format_key::varchar(12) as sap_banner_format_key,
       sap_banner_format_description::varchar(75) as sap_banner_format_description,
       retail_environment::varchar(50) as retail_environment,
       region::varchar(150) as region,
       zone::varchar(150) as zone,
       city::varchar(150) as city,
       customer_segment_key::varchar(12) as customer_segment_key,
       customer_segment_description::varchar(50) as customer_segment_description,
       global_product_franchise::varchar(30) as global_product_franchise,
       global_product_brand::varchar(30) as global_product_brand,
       global_product_sub_brand::varchar(100) as global_product_sub_brand,
       global_product_variant::varchar(100) as global_product_variant,
       global_product_segment::varchar(50) as global_product_segment,
       global_product_subsegment::varchar(100) as global_product_subsegment,
       global_product_category::varchar(50) as global_product_category,
       global_product_subcategory::varchar(50) as global_product_subcategory,
       global_put_up_description::varchar(100) as global_put_up_description,
       pka_product_key::varchar(68) as pka_product_key,
       pka_product_key_desc::varchar(382) as pka_product_key_desc,
	   sls_qty::numeric(38,6) AS so_sls_qty,	
	   sls_value::numeric(38,6) AS so_sls_value,	
	   avg_qty::numeric(38,6) AS so_avg_qty,	
	   sales_value_list_price::numeric(38,12) AS sales_value_list_price,	
	   crt_dttm::timestamp without time zone AS crt_dttm
FROM cnpc_base_retail_excellence
)

select * from final