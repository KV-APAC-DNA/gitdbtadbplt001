WITH KESAI_H_DATA_MART_SUB_N AS
(
    select * from {{ ref('jpndcledw_integration__kesai_h_data_mart_sub_n') }}
),
KESAI_H_DATA_MART_SUB_P AS
(
    select * from {{ source('jpdcledw_integration', 'kesai_h_data_mart_sub_p') }}
),
KESAI_H_DATA_MART_SUB_N_H_MNGY AS
(
    select * from {{ source('jpdcledw_integration', 'kesai_h_data_mart_sub_n_h_mngy') }}
),

final as
(
    SELECT 
        CN.SALENO,
        CN.JUCHKBN,
        CN.JUCHYM,
        CN.JUCHDATE,
        CN.JUCHQUARTER,
        CN.JUCHJIGYOKI,
        CN.KOKYANO,
        CN.TORIKEIKBN,
        CN.CANCELFLG,
        CN.HANROCODE,
        CN.SYOHANROBUNNAME,
        CN.CHUHANROBUNNAME,
        CN.DAIHANROBUNNAME,
        CN.MEDIACODE,
        CN.SORYO,
        CN.TAX,
        CN.SOGOKEI,
        CN.TENPOCODE,
        CN.SHUKAYM,
        CN.SHUKADATE,
        CN.SHUKAQUARTER,
        CN.SHUKAJIGYOKI,
        CN.ZIPCODE,
        CN.TODOFUKENCODE,
        CN.RIYOPOINT,
        CN.HAPPENPOINT,
        CN.KESSAIKBN,
        CN.CARDCORPCODE,
        CN.HENREASONCODE,
        CN.MOTOINSERTID,
        CN.MOTOINSERTDATE,
        CN.MOTOUPDATEDATE,
        CN.INSERTDATE,
        CN.INSERTTIME,
        CN.INSERTID,
        CN.UPDATEDATE,
        CN.UPDATETIME,
        CN.UPDATEID,
        CN.RANK,
        CN.DISPSALENO,
        CN.KESAIID,
        CN.ORDERCODE,
        CN.HENREASONNAME,
        CN.UKETSUKEUSRID,
        CN.UKETSUKETELCOMPANYCD,
        CN.SMKEIROID,
        CN.DIPROMID,
        CN.SALENO_TRM,
        CN.DICOLLECTPRC,
        CN.DITOUJITSUHAISOPRC,
        CN.DIDISCOUNTALL,
        CN.C_DIDISCOUNTPRC,
        CN.POINT_EXCHANGE,
        CN.LOGINCODE,
        CN.MAKER,
        CN.TODOFUKEN_CODE,
        CN.SHUKKASTS,
        CN.DIVOUCHERCODE,
        CN.DITAXRATE,
        CN.DISEIKYUREMAIN,
        CN.DINYUKINSTS,
        CN.DICARDNYUKINSTS,
        CN.DISOKOID,
        CN.DIHAISOKEITAI,
        CP.SALENO AS SALENO_P,
        CP.SHUKADATE AS SHUKADATE_P,
        CP.SHOHINGOKEI,
        CP.KOMIWARIKINGAKU,
        CP.WARIMAENUKIGOKEI,
        CP.WARIMAETAX,
        CP.SHOKEI,
        CP.TAX AS TAX_P,
        CP.TRANSBINCODE,
        CP.NUKIKINGAKU,
        CP.KIBOUDATE,
        CP.TOKUICODE,
        CP.SOGOKEI AS SOGOKEI_P,
        CP.SENDENNO,
        CP.INSERTDATE AS INSERTDATE_P,
        CP.INSERTTIME AS INSERTTIME_P,
        CP.UPDATEDATE AS UPDATEDATE_P,
        CP.UPDATETIME AS UPDATETIME_P,
        CP.KKNG_KBN,
        CP.TUKA_CD,
        CP.SHOKEI_TUKA,
        CP.TAX_TUKA,
        CP.SOGOKEI_TUKA,
        CP.JUCHNO,
        CP.JUCHNIBUNO,
        CP.HENREASONNAME AS HENREASONNAME_P,
        CP.HENREASONCODE AS HENREASONCODE_P,
        CP.TORIKEIKBN AS TORIKEIKBN_P,
        CP.JUCHDATE AS JUCHDATE_P,
        CP.TENPOCODE AS TENPOCODE_P,
        CP.TENPOBUNRUI,
        CP.SHOKUIKIBUNRUI,
        CP.CONTEA,
        CP.CONTEB,
        CP.CONTEC,
        CP.CONTED,
        CP.CONTEE,
        CP.CONTEF,
        CP.CONTEG,
        CP.CONTEH,
        CP.CONTEI,
        CP.CONTEJ,
        CP.FSKBN,
        CP.BMN_HYOUJI_CD,
        CP.BMN_NMS,
        CP.PROCESSTYPE_CD,
        CP.DAIHYOU_SHUKASK_CD,
        CP.DAIHYOU_SHUKASK_NMR,
        CP.INSERTID AS INSERTID_P,
        CP.TOKUINAME_ASPAC,
        CP.SKYSK_NAME,
        CP.SKYSK_CD,
        CP.JUCH_BKO,
        CP.MARKER,
        CP.URI_HEN_KBN,
        CP.SAL_JISK_IMP_SNSH_NO,
        '1' AS PORT_UNIQ_FLG
        FROM KESAI_H_DATA_MART_SUB_N CN
        LEFT JOIN KESAI_H_DATA_MART_SUB_P CP ON CN.DISPSALENO = CP.SAL_JISK_IMP_SNSH_NO
        AND CP.URI_HEN_KBN = 'U'
        WHERE CN.MAKER = 1

        UNION ALL

        SELECT CN.SALENO,
        CN.JUCHKBN,
        CN.JUCHYM,
        CN.JUCHDATE,
        CN.JUCHQUARTER,
        CN.JUCHJIGYOKI,
        CN.KOKYANO,
        CN.TORIKEIKBN,
        CN.CANCELFLG,
        CN.HANROCODE,
        CN.SYOHANROBUNNAME,
        CN.CHUHANROBUNNAME,
        CN.DAIHANROBUNNAME,
        CN.MEDIACODE,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, CN.SORYO, 0), CN.SORYO) AS SORYO,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, CN.TAX, 0), CN.TAX) AS TAX,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, CN.SOGOKEI, 0), CN.SOGOKEI) AS SOGOKEI,
        CN.TENPOCODE,
        CN.SHUKAYM,
        CN.SHUKADATE,
        CN.SHUKAQUARTER,
        CN.SHUKAJIGYOKI,
        CN.ZIPCODE,
        CN.TODOFUKENCODE,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, CN.RIYOPOINT, 0), CN.RIYOPOINT) AS RIYOPOINT,
        CN.HAPPENPOINT,
        CN.KESSAIKBN,
        CN.CARDCORPCODE,
        CN.HENREASONCODE,
        CN.MOTOINSERTID,
        CN.MOTOINSERTDATE,
        CN.MOTOUPDATEDATE,
        CN.INSERTDATE,
        CN.INSERTTIME,
        CN.INSERTID,
        CN.UPDATEDATE,
        CN.UPDATETIME,
        CN.UPDATEID,
        CN.RANK,
        CN.DISPSALENO,
        CN.KESAIID,
        CN.ORDERCODE,
        CN.HENREASONNAME,
        CN.UKETSUKEUSRID,
        CN.UKETSUKETELCOMPANYCD,
        CN.SMKEIROID,
        CN.DIPROMID,
        CN.SALENO_TRM,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, CN.DICOLLECTPRC, 0), CN.DICOLLECTPRC) AS DICOLLECTPRC,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, CN.DITOUJITSUHAISOPRC, 0), CN.DITOUJITSUHAISOPRC) AS DITOUJITSUHAISOPRC,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, CN.DIDISCOUNTALL, 0), CN.DIDISCOUNTALL) AS DIDISCOUNTALL,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, CN.C_DIDISCOUNTPRC, 0), CN.C_DIDISCOUNTPRC) AS C_DIDISCOUNTPRC,
        CN.POINT_EXCHANGE,
        CN.LOGINCODE,
        CN.MAKER,
        CN.TODOFUKEN_CODE,
        CN.SHUKKASTS,
        CN.DIVOUCHERCODE,
        CN.DITAXRATE,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, CN.DISEIKYUREMAIN, 0), CN.DISEIKYUREMAIN) AS DISEIKYUREMAIN,
        CN.DINYUKINSTS,
        CN.DICARDNYUKINSTS,
        CN.DISOKOID,
        CN.DIHAISOKEITAI,
        CP.SALENO AS SALENO_P,
        CP.SHUKADATE AS SHUKADATE_P,
        CP.SHOHINGOKEI,
        CP.KOMIWARIKINGAKU,
        CP.WARIMAENUKIGOKEI,
        CP.WARIMAETAX,
        CP.SHOKEI,
        CP.TAX AS TAX_P,
        CP.TRANSBINCODE,
        CP.NUKIKINGAKU,
        CP.KIBOUDATE,
        CP.TOKUICODE,
        CP.SOGOKEI AS SOGOKEI_P,
        CP.SENDENNO,
        CP.INSERTDATE AS INSERTDATE_P,
        CP.INSERTTIME AS INSERTTIME_P,
        CP.UPDATEDATE AS UPDATEDATE_P,
        CP.UPDATETIME AS UPDATETIME_P,
        CP.KKNG_KBN,
        CP.TUKA_CD,
        CP.SHOKEI_TUKA,
        CP.TAX_TUKA,
        CP.SOGOKEI_TUKA,
        CP.JUCHNO,
        CP.JUCHNIBUNO,
        CP.HENREASONNAME AS HENREASONNAME_P,
        CP.HENREASONCODE AS HENREASONCODE_P,
        CP.TORIKEIKBN AS TORIKEIKBN_P,
        CP.JUCHDATE AS JUCHDATE_P,
        CP.TENPOCODE AS TENPOCODE_P,
        CP.TENPOBUNRUI,
        CP.SHOKUIKIBUNRUI,
        CP.CONTEA,
        CP.CONTEB,
        CP.CONTEC,
        CP.CONTED,
        CP.CONTEE,
        CP.CONTEF,
        CP.CONTEG,
        CP.CONTEH,
        CP.CONTEI,
        CP.CONTEJ,
        CP.FSKBN,
        CP.BMN_HYOUJI_CD,
        CP.BMN_NMS,
        CP.PROCESSTYPE_CD,
        CP.DAIHYOU_SHUKASK_CD,
        CP.DAIHYOU_SHUKASK_NMR,
        CP.INSERTID AS INSERTID_P,
        CP.TOKUINAME_ASPAC,
        CP.SKYSK_NAME,
        CP.SKYSK_CD,
        CP.JUCH_BKO,
        CP.MARKER,
        CP.URI_HEN_KBN,
        CP.SAL_JISK_IMP_SNSH_NO,
        NVL2(CP.SALENO, NVL2(MIN.SALENO, '1', '0'), '1') AS PORT_UNIQ_FLG
        FROM KESAI_H_DATA_MART_SUB_N CN
        LEFT JOIN KESAI_H_DATA_MART_SUB_P CP ON CN.DISPSALENO = CP.SAL_JISK_IMP_SNSH_NO
        AND CP.URI_HEN_KBN = 'H'
        LEFT JOIN KESAI_H_DATA_MART_SUB_N_H_MNGY MIN ON CP.SALENO = MIN.SALENO
        WHERE CN.MAKER = 2

        UNION ALL

        SELECT CP.SALENO AS SALENO,
        CASE 
            WHEN CP.URI_HEN_KBN = 'U'
                THEN '0'
            ELSE '90'
            END JUCHKBN,
        '0' AS JUCHYM,
        0 AS JUCHDATE,
        '0' AS JUCHQUARTER,
        '0' AS JUCHJIGYOKI,
        'DUMMY' AS KOKYANO,
        CP.TORIKEIKBN AS TORIKEIKBN,
        'DUMMY' AS CANCELFLG,
        'DUMMY' AS HANROCODE,
        'DUMMY' AS SYOHANROBUNNAME,
        'DUMMY' AS CHUHANROBUNNAME,
        'DUMMY' AS DAIHANROBUNNAME,
        'DUMMY' AS MEDIACODE,
        0 AS SORYO,
        0 AS TAX,
        0 AS SOGOKEI,
        'DUMMY' AS TENPOCODE,
        '0' AS SHUKAYM,
        0 AS SHUKADATE,
        '0' AS SHUKAQUARTER,
        '0' AS SHUKAJIGYOKI,
        'DUMMY' AS ZIPCODE,
        'DUMMY' AS TODOFUKENCODE,
        0 AS RIYOPOINT,
        0 AS HAPPENPOINT,
        'DUMMY' AS KESSAIKBN,
        'DUMMY' AS CARDCORPCODE,
        'DUMMY' AS HENREASONCODE,
        'DUMMY' AS MOTOINSERTID,
        0 AS MOTOINSERTDATE,
        0 AS MOTOUPDATEDATE,
        0 AS INSERTDATE,
        0 AS INSERTTIME,
        'DUMMY' AS INSERTID,
        0 AS UPDATEDATE,
        0 AS UPDATETIME,
        'DUMMY' AS UPDATEID,
        0 AS RANK,
        'DUMMY' AS DISPSALENO,
        'DUMMY' AS KESAIID,
        'DUMMY' AS ORDERCODE,
        'DUMMY' AS HENREASONNAME,
        0 AS UKETSUKEUSRID,
        'DUMMY' AS UKETSUKETELCOMPANYCD,
        0 AS SMKEIROID,
        0 AS DIPROMID,
        'DUMMY' AS SALENO_TRM,
        0 AS DICOLLECTPRC,
        0 AS DITOUJITSUHAISOPRC,
        0 AS DIDISCOUNTALL,
        0 AS C_DIDISCOUNTPRC,
        0 AS POINT_EXCHANGE,
        'DUMMY' AS LOGINCODE,
        0 AS MAKER,
        'DUMMY' AS TODOFUKEN_CODE,
        DECODE(CP.SHUKADATE, 0, '1010', '1060') AS SHUKKASTS,
        'DUMMY' AS DIVOUCHERCODE,
        0 AS DITAXRATE,
        0 AS DISEIKYUREMAIN,
        'DUMMY' AS DINYUKINSTS,
        'DUMMY' AS DICARDNYUKINSTS,
        0 AS DISOKOID,
        0 AS DIHAISOKEITAI,
        CP.SALENO AS SALENO_P,
        CP.SHUKADATE AS SHUKADATE_P,
        CP.SHOHINGOKEI,
        CP.KOMIWARIKINGAKU,
        CP.WARIMAENUKIGOKEI,
        CP.WARIMAETAX,
        CP.SHOKEI,
        CP.TAX AS TAX_P,
        CP.TRANSBINCODE,
        CP.NUKIKINGAKU,
        CP.KIBOUDATE,
        CP.TOKUICODE,
        CP.SOGOKEI AS SOGOKEI_P,
        CP.SENDENNO,
        CP.INSERTDATE AS INSERTDATE_P,
        CP.INSERTTIME AS INSERTTIME_P,
        CP.UPDATEDATE AS UPDATEDATE_P,
        CP.UPDATETIME AS UPDATETIME_P,
        CP.KKNG_KBN,
        CP.TUKA_CD,
        CP.SHOKEI_TUKA,
        CP.TAX_TUKA,
        CP.SOGOKEI_TUKA,
        CP.JUCHNO,
        CP.JUCHNIBUNO,
        CP.HENREASONNAME AS HENREASONNAME_P,
        CP.HENREASONCODE AS HENREASONCODE_P,
        CP.TORIKEIKBN AS TORIKEIKBN_P,
        CP.JUCHDATE AS JUCHDATE_P,
        CP.TENPOCODE AS TENPOCODE_P,
        CP.TENPOBUNRUI,
        CP.SHOKUIKIBUNRUI,
        CP.CONTEA,
        CP.CONTEB,
        CP.CONTEC,
        CP.CONTED,
        CP.CONTEE,
        CP.CONTEF,
        CP.CONTEG,
        CP.CONTEH,
        CP.CONTEI,
        CP.CONTEJ,
        CP.FSKBN,
        CP.BMN_HYOUJI_CD,
        CP.BMN_NMS,
        CP.PROCESSTYPE_CD,
        CP.DAIHYOU_SHUKASK_CD,
        CP.DAIHYOU_SHUKASK_NMR,
        CP.INSERTID AS INSERTID_P,
        CP.TOKUINAME_ASPAC,
        CP.SKYSK_NAME,
        CP.SKYSK_CD,
        CP.JUCH_BKO,
        CP.MARKER,
        CP.URI_HEN_KBN,
        CP.SAL_JISK_IMP_SNSH_NO,
        '1' AS PORT_UNIQ_FLG
        FROM KESAI_H_DATA_MART_SUB_P CP
        LEFT JOIN KESAI_H_DATA_MART_SUB_N CN ON CN.DISPSALENO = CP.SAL_JISK_IMP_SNSH_NO
        WHERE CN.DISPSALENO IS NULL
        OR CN.DISPSALENO = ''
)
select * from final