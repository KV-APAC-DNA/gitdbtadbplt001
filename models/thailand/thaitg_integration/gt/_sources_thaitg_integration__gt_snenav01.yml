version: 2

sources:
  - name: thasdl_raw
    database: "{{ env_var('DBT_ENV_LOAD_DB') }}"
    schema: thasdl_raw
    quoting:
      database: false
      schema: false
      identifier: false
    tables:

    - name: sdl_mds_th_distributor_target_sales_re
      tags: ["th_non_tesco",""]
      tests:
          - test_null:
              not_null_columns: ["distributorid","re_code","period"]
              name: TRATBL_sdl_mds_th_distributor_target_sales_re__null_test
              config:
                store_failures: true
                schema: thawks_integration
          - test_duplicate:
              group_by_columns: ["distributorid","re_code","period"]
              select_columns: ["distributorid","re_code","period"]
              name: TRATBL_sdl_mds_th_distributor_target_sales_re__duplicate_test
              config:
                store_failures: true
                schema: thawks_integration

    - name: sdl_mds_th_gt_kpi_target
      tags: ["th_non_tesco"]
      tests:
        - test_null:
              not_null_columns: ["year","kpi_code","kpi_desc"]
              select_columns: ["year","kpi_code","kpi_desc"]
              name: TRATBL_sdl_mds_th_gt_kpi_target__null_test
              config:
                store_failures: true
                schema: thawks_integration
        - test_duplicate:
            group_by_columns: ["year","kpi_code","kpi_desc","re_code"]
            select_columns: ["year","kpi_code","kpi_desc"]
            need_counts: "no"
            name: TRATBL_sdl_mds_th_gt_kpi_target__duplicate_test
            config:
              store_failures: true
              schema: thawks_integration
        - test_lookup:
            select_columns: ["year","kpi_code","kpi_desc"]
            column: "year" 
            lookup_column: "cast(trim(year) as numeric(31)) as year "
            lookup_table: "{{ source('thasdl_raw', 'sdl_mds_th_gt_kpi_target') }}"
            lookup_filter: "not regexp_like(cast(trim(year) as decimal(31)),'(20)[0-9]{2}')=false"
            name: TRATBL_sdl_mds_th_gt_kpi_target__lookup_test
            config:
              store_failures: true
              schema: thawks_integration

    - name: sdl_mds_th_gt_productive_call_target
      tags: ["th_non_tesco"]
      tests:
          - test_null:
              not_null_columns: ["saleunit","saleid","month","year"]
              select_columns: ["saleunit","saleid","month","year"]
              name: TRATBL_sdl_mds_th_gt_productive_call_target__null_test
              config:
                store_failures: true
                schema: thawks_integration

          - test_duplicate:
              group_by_columns: ["saleunit","saleid","month","year"]
              select_columns: ["saleunit","saleid","month","year"]
              name: TRATBL_sdl_mds_th_gt_productive_call_target__duplicate_test
              config:
                store_failures: true
                schema: thawks_integration

          - test_column:
              compare_columns: ["saleunit","saleid"]
              select_columns: ["saleunit","saleid","month","year"]
              name: TRATBL_sdl_mds_th_gt_productive_call_target__test_column
              config:
                store_failures: true
                schema: thawks_integration

          - test_column_lookup:
                  select_columns: ["year","month","saleunit","saleid"]
                  lpad_column: ["month"]
                  lookup_table: "{{ source('thasdl_raw', 'sdl_mds_th_gt_productive_call_target') }}"
                  lookup_column: "year"
                  lookup_filter: "(A.YEAR || A.MONTH) = B.YEAR_MONTH AND B.RESULT = FALSE)"
                  name: TRATBL_sdl_mds_th_gt_productive_call_target__lookup_test
                  config:
                    store_failures: true
                    schema: thawks_integration
    - name: sdl_mym_gt_sales_report_fact
      tags: ["myanmar_file_ingestion"]
      tests:
          - test_null:
              not_null_columns: ["filename","item_no","customer_code","customer_name","period"]
              select_columns: ["filename","item_no","customer_code","customer_name","period"]
              name: TRATBL_sdl_mym_gt_sales_report_fact__null_test
              config:
                store_failures: true
                schema: thawks_integration

          - test_duplicate:
              group_by_columns: ["item_no","customer_code","period"]
              select_columns: ["filename","item_no","customer_code","customer_name","period"]
              name: TRATBL_sdl_mym_gt_sales_report_fact__duplicate_test
              config:
                store_failures: true
                schema: thawks_integration
          - test_filter:
              select_columns: ["filename","item_no","customer_code","customer_name","period"]
              failure_reason: "'INVALID Date : Correct Format is DD/MM/YYYY'"
              where_clause: " not regexp_like(trim(substring(period,1,10)), '[0-3][0-9]/[0-1][0-9]/[1-2][0-9][0-9][0-9]')"          
              name: TRATBL_sdl_mym_gt_sales_report_fact__test_filter
              config:
                store_failures: true
                schema: thawks_integration
    - name: sdl_la_gt_route_detail
      tags: ["laos_file_ingestion"]
      tests:
          - test_null:
              not_null_columns: ["route_id","customer_id","saleunit","created_date"]
              select_columns: ["filename","route_id","customer_id","saleunit","created_date"]
              name: TRATBL_sdl_la_gt_route_detail__null_test
              config:
                store_failures: true
                schema: thawks_integration

          - test_duplicate:
              group_by_columns: ["filename","route_id","customer_id","saleunit","created_date"]
              select_columns: ["filename","route_id","customer_id","saleunit","created_date"]
              name: TRATBL_sdl_la_gt_route_detail__duplicate_test
              config:
                store_failures: true
                schema: thawks_integration
          - test_filter:
              select_columns: ["filename","route_id","customer_id","saleunit","created_date"]
              failure_reason:  "'INVALID CREATED_DATE'"
              where_clause: "not regexp_like(TRIM(created_date),'[1-2][0-9][0-9][0-9][0-1][0-9][0-3][0-9]')"         
              name: TRATBL_sdl_la_gt_route_detail__test_filter_created_date
              config:
                store_failures: true
                schema: thawks_integration
          - test_filter:
              select_columns: ["filename","route_id","customer_id","saleunit","created_date"]
              failure_reason:  "'SALEUNIT IS NOT MATCHING WITH DISTRIBUTOR AVAILABLE IN FILE NAME'"
              where_clause: "split_part(upper(trim(filename)), '_', 2) <> upper(trim(saleunit))"         
              name: TRATBL_sdl_la_gt_route_detail__test_filter_sale_unit
              config:
                store_failures: true
                schema: thawks_integration
          

