version: 2

sources:
  - name: thasdl_raw
    database: "{{ env_var('DBT_ENV_LOAD_DB') }}"
    schema: thasdl_raw
    quoting:
      database: false
      schema: false
      identifier: false
    tables:

    - name: sdl_mds_th_distributor_target_sales_re
      tags: ["th_non_tesco",""]
      tests:
          - test_null:
              not_null_columns: ["distributorid","re_code","period"]
              name: TRATBL_sdl_mds_th_distributor_target_sales_re__null_test
              config:
                store_failures: true
                schema: thawks_integration
          - test_duplicate:
              group_by_columns: ["distributorid","re_code","period"]
              select_columns: ["distributorid","re_code","period"]
              name: TRATBL_sdl_mds_th_distributor_target_sales_re__duplicate_test
              config:
                store_failures: true
                schema: thawks_integration

    - name: sdl_mds_th_gt_kpi_target
      tags: ["th_non_tesco"]
      tests:
        - test_null:
              not_null_columns: ["year","kpi_code","kpi_desc"]
              select_columns: ["year","kpi_code","kpi_desc"]
              name: TRATBL_sdl_mds_th_gt_kpi_target__null_test
              config:
                store_failures: true
                schema: thawks_integration
        - test_duplicate:
            group_by_columns: ["year","kpi_code","kpi_desc","re_code"]
            select_columns: ["year","kpi_code","kpi_desc"]
            need_counts: "no"
            name: TRATBL_sdl_mds_th_gt_kpi_target__duplicate_test
            config:
              store_failures: true
              schema: thawks_integration
        - test_lookup:
            select_columns: ["year","kpi_code","kpi_desc"]
            column: "year" 
            lookup_column: "cast(trim(year) as numeric(31)) as year "
            lookup_table: "{{ source('thasdl_raw', 'sdl_mds_th_gt_kpi_target') }}"
            lookup_filter: "not regexp_like(cast(trim(year) as decimal(31)),'(20)[0-9]{2}')=false"
            name: TRATBL_sdl_mds_th_gt_kpi_target__lookup_test
            config:
              store_failures: true
              schema: thawks_integration

    - name: sdl_mds_th_gt_productive_call_target
      tags: ["th_non_tesco"]
      tests:
          - test_null:
              not_null_columns: ["saleunit","saleid","month","year"]
              select_columns: ["saleunit","saleid","month","year"]
              name: TRATBL_sdl_mds_th_gt_productive_call_target__null_test
              config:
                store_failures: true
                schema: thawks_integration

          - test_duplicate:
              group_by_columns: ["saleunit","saleid","month","year"]
              select_columns: ["saleunit","saleid","month","year"]
              name: TRATBL_sdl_mds_th_gt_productive_call_target__duplicate_test
              config:
                store_failures: true
                schema: thawks_integration

          - test_column:
              compare_columns: ["saleunit","saleid"]
              select_columns: ["saleunit","saleid","month","year"]
              name: TRATBL_sdl_mds_th_gt_productive_call_target__test_column
              config:
                store_failures: true
                schema: thawks_integration

          - test_column_lookup:
                  select_columns: ["year","month","saleunit","saleid"]
                  lpad_column: ["month"]
                  lookup_table: "{{ source('thasdl_raw', 'sdl_mds_th_gt_productive_call_target') }}"
                  lookup_column: "year"
                  lookup_filter: "(A.YEAR || A.MONTH) = B.YEAR_MONTH AND B.RESULT = FALSE)"
                  name: TRATBL_sdl_mds_th_gt_productive_call_target__lookup_test
                  config:
                    store_failures: true
                    schema: thawks_integration
    - name: sdl_th_gt_route
      tests:
          - test_null:
                not_null_columns: ["filename","saleunit","routeid","routesale","last_updated_date"]
                select_columns: ["filename","saleunit","routeid","routesale","last_updated_date"]
                name: TRATBL_sdl_th_gt_route__null_test
                config:
                  store_failures: true
                  schema: thawks_integration
          - test_duplicate:
              group_by_columns: ["filename","saleunit","routeid","routesale","last_updated_date"]
              select_columns: ["filename","saleunit","routeid","routesale","last_updated_date"]
              need_counts: "no"
              name: TRATBL_sdl_th_gt_route__duplicate_test
              config:
                store_failures: true
                schema: thawks_integration
          - test_format:
              where_clause: "split_part(upper(trim(filename)),'_',2) <>upper(trim(saleunit))"
              failure_reason: "'SALEUNIT IS NOT MATCHING WITH DISTRIBUTOR AVAILABLE IN FILE NAME: ' || 'FILENAME' || '(OR)' || 'SALEUNIT'"
              select_columns: ["filename","saleunit","routeid","routesale","last_updated_date"]
              name: TRATBL_sdl_th_gt_route__test_format
              config:
                store_failures: true
                schema: thawks_integration

          - test_date_format_odd_eve_leap:
                model_nm: "{{ source('thasdl_raw', 'sdl_th_gt_route') }}"
                date_column: "LAST_UPDATED_DATE"
                filter: "(odd_mon.LAST_UPDATED_DATE) = (even_mon.LAST_UPDATED_DATE) and (even_mon.LAST_UPDATED_DATE) = (feb.LAST_UPDATED_DATE) and (odd_mon.result) = (even_mon.result) and (even_mon.result) = (feb.result)"
                failure_reason: "'LAST_UPDATED_DATE HAVING INCORRECT DATE-FORMAT. EXPECTED: YYYYMMDD'"
                select_columns: ["filename","saleunit","routeid","routesale","last_updated_date"]
                name: TRATBL_sdl_th_gt_route__test_date_format_odd_eve_leap
                config:
                  store_failures: true
                  schema: thawks_integration
    - name: sdl_th_gt_route_detail
      tests:
            - test_null:
                  not_null_columns: ["filename","routeid","routeno","saleunit","customerid","created_date"]
                  select_columns: ["filename","routeid","routeno","saleunit","customerid","created_date"]
                  name: TRATBL_sdl_th_gt_route_detail__null_test
                  config:
                    store_failures: true
                    schema: thawks_integration
            - test_duplicate:
                group_by_columns: ["filename","routeid","routeno","saleunit","customerid","created_date"]
                select_columns: ["filename","routeid","routeno","saleunit","customerid","created_date"]
                need_counts: "no"
                name: TRATBL_sdl_th_gt_route_detail__duplicate_test
                config:
                  store_failures: true
                  schema: thawks_integration
            - test_format:
                where_clause: "SPLIT_PART(UPPER(TRIM(FILENAME)),'_',2) <>UPPER(TRIM(SALEUNIT))"
                failure_reason: "'SALEUNIT IS NOT MATCHING WITH DISTRIBUTOR AVAILABLE IN FILE NAME: ' || 'FILENAME' || '(OR)' || 'SALEUNIT'"
                select_columns: ["filename","routeid","routeno","saleunit","customerid","created_date"]
                name: TRATBL_sdl_th_gt_route_detail__test_format
                config:
                  store_failures: true
                  schema: thawks_integration

            - test_date_format_odd_eve_leap:
                  model_nm: "{{ source('thasdl_raw', 'sdl_th_gt_route_detail') }}"
                  date_column: "CREATED_DATE"
                  filter: "(odd_mon.CREATED_DATE) = (even_mon.CREATED_DATE) and (even_mon.CREATED_DATE) = (feb.CREATED_DATE) and (odd_mon.result) = (even_mon.result) and (even_mon.result) = (feb.result)"
                  failure_reason: "'CREATED_DATE HAVING INCORRECT DATE-FORMAT. EXPECTED: YYYYMMDD'"
                  select_columns: ["filename","routeid","routeno","saleunit","customerid","created_date"]
                  name: TRATBL_sdl_th_gt_route_detail__test_date_format_odd_eve_leap
                  config:
                    store_failures: true
                    schema: thawks_integration
    - name: sdl_th_gt_sales_order
      tests:
              - test_null:
                    not_null_columns: ["filename","saleunit","orderid","customer_id","productid","sales_order_line_no"]
                    select_columns: ["filename","saleunit","orderid","customer_id","productid","sales_order_line_no"]
                    name: TRATBL_sdl_th_gt_sales_order__null_test
                    config:
                      store_failures: true
                      schema: thawks_integration
              - test_duplicate:
                  group_by_columns: ["filename","saleunit","orderid","customer_id","productid","sales_order_line_no"]
                  select_columns: ["filename","saleunit","orderid","customer_id","productid","sales_order_line_no"]
                  need_counts: "no"
                  name: TRATBL_sdl_th_gt_sales_order__duplicate_test
                  config:
                    store_failures: true
                    schema: thawks_integration
              - test_format:
                  where_clause: "SPLIT_PART(UPPER(TRIM(FILENAME)),'_',2) <> UPPER(TRIM(SALEUNIT))"
                  failure_reason: "'SALEUNIT IS NOT MATCHING WITH DISTRIBUTOR AVAILABLE IN FILE NAME:  || FILENAME|| (OR) || SALEUNIT'"
                  select_columns: ["filename","saleunit","orderid","customer_id","productid","sales_order_line_no"]
                  name: TRATBL_sdl_th_gt_sales_order__test_format
                  config:
                    store_failures: true
                    schema: thawks_integration
              - test_date_format_odd_eve_leap:
                    model_nm: "{{ source('thasdl_raw', 'sdl_th_gt_sales_order') }}"
                    date_column: "ORDERDATE"
                    filter: "(odd_mon.ORDERDATE) = (even_mon.ORDERDATE) and (even_mon.ORDERDATE) = (feb.ORDERDATE) and (odd_mon.result) = (even_mon.result) and (even_mon.result) = (feb.result)"
                    failure_reason: "'ORDERDATE HAVING INCORRECT DATE-FORMAT. EXPECTED: YYYYMMDD'"
                    select_columns: ["filename","saleunit","orderid","customer_id","productid","sales_order_line_no"]
                    name: TRATBL_sdl_th_gt_sales_order__test_date_format_odd_eve_leap
                    config:
                      store_failures: true
                      schema: thawks_integration
    - name: sdl_cbd_gt_sales_report_fact
      tests:
                - test_null:
                      not_null_columns: ["filename","billing_date","order_no","sales_rep_no","customer_code","product_code","batch_no"]
                      select_columns: ["filename","billing_date","order_no","sales_rep_no","customer_code","product_code","batch_no"]
                      name: TRATBL_sdl_cbd_gt_sales_report_fact__null_test
                      config:
                        store_failures: true
                        schema: thawks_integration
                - test_duplicate:
                    group_by_columns: ["filename","billing_date","order_no","sales_rep_no","customer_code","product_code","batch_no"]
                    select_columns: ["filename","billing_date","order_no","sales_rep_no","customer_code","product_code","batch_no"]
                    need_counts: "no"
                    name: TRATBL_sdl_cbd_gt_sales_report_fact__duplicate_test
                    config:
                      store_failures: true
                      schema: thawks_integration
                - test_format:
                    where_clause: "not regexp_like(billing_date , '[0-3][0-9]/[0-1][0-9]/[1-2][0-9][0-9][0-9]' )"
                    failure_reason: "'INVALID Billing Date : Correct Format is DD/MM/YYYY'"
                    select_columns: ["filename","billing_date","order_no","sales_rep_no","customer_code","product_code","batch_no"]
                    name: TRATBL_sdl_cbd_gt_sales_report_fact__test_format
                    config:
                      store_failures: true
                      schema: thawks_integration
                - test_format:
                    where_clause: "not regexp_like(expiry_date , '[0-3][0-9]/[0-1][0-9]/[0-9][0-9][0-9][0-9]' )"
                    failure_reason: "'INVALID expiry Date : Correct Format is DD/MM/YYYY'"
                    select_columns: ["filename","billing_date","order_no","sales_rep_no","customer_code","product_code","batch_no"]
                    name: TRATBL_sdl_cbd_gt_sales_report_fact__test_format_2
                    config:
                      store_failures: true
                      schema: thawks_integration
                

    - name: sdl_la_gt_sales_order_fact
    - name: sdl_la_gt_route_header
    - name: sdl_la_gt_route_detail

  - name: thawks_integration
    database: "{{ env_var('DBT_ENV_CORE_DB') }}"
    schema: thawks_integration
    quoting:
      database: false
      schema: false
      identifier: false
    tables:
      - name: wks_th_gt_route_hashkey
      - name: wks_th_gt_route_detail_hashkey
      - name: wks_th_gt_sales_order_pre_load
      - name: wks_cbd_gt_sales_report_fact_pre_load
      - name: wks_la_gt_sales_order_fact_pre_load
      - name: wks_la_gt_route_header_hashkey
      - name: wks_la_gt_route_detail_hashkey
