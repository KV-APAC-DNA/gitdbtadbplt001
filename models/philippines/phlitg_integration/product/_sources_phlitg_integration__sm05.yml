version: 2

sources:
  - name: phlsdl_raw
    database: "{{ env_var('DBT_ENV_LOAD_DB') }}"
    schema: snaposesdl_raw
    quoting:
      database: false
      schema: false
      identifier: false
    tables:
    - name: sdl_ph_sfmc_bounce_data
      tags: ["ph_sfmc_files","ingestion"]
      tests:
        - test_duplicate:
            group_by_columns: ["job_id","batch_id","subscriber_id","subscriber_key","event_date","email_id","file_name"]
            select_columns: ["job_id","batch_id","subscriber_id","subscriber_key","event_date","email_id","file_name"]
            name: TRATBL_sdl_ph_sfmc_bounce_data__duplicate_test
            config:
              store_failures: true
              schema: phlwks_integration
        - test_null:
            not_null_columns: ["subscriber_key","event_date","email_name","job_id","batch_id"]
            select_columns: ["job_id","batch_id","subscriber_id","subscriber_key","event_date","email_id","file_name"]
            name: TRATBL_sdl_ph_sfmc_bounce_data__null_test
            config:
              store_failures: true
              schema: phlwks_integration
        - test_format:
            select_columns: ["job_id","batch_id","subscriber_id","subscriber_key","event_date","email_id","file_name"]
            where_clause: " not regexp_like (substring(event_date,1,10),'[1-2][0-9][0-9][0-9]-[0-1][0-9]-[0-3][0-9]')"
            failure_reason: "'event_date format is not expected, expected format is YYYY-MM-DD ...for SUBSCRIBER_KEY & actual event_date'"
            name: TRATBL_sdl_ph_sfmc_bounce_data__format_test
            config:
              store_failures: true
              schema: phlwks_integration
    - name: sdl_ph_non_ise_landmark_sm
    - name: sdl_ph_non_ise_landmark_ds
    - name: sdl_ph_non_ise_puregold
    - name: sdl_ph_non_ise_robinsons_ds
    - name: sdl_ph_non_ise_robinsons_sm
    - name: sdl_ph_non_ise_rustans
    - name: sdl_ph_non_ise_shm
      tags: ["ph_perfectstore_survey_transaction","ingestion"]
      tests:
          - test_null:
              select_columns: ["filename", "retailer_name", "sku_code", "osa_check_date", "branch_code", "ret_nm_prefix"]
              not_null_columns: ["retailer_name", "sku_code", "osa_check_date", "branch_code", "ret_nm_prefix"]
              name: TRATBL_sdl_ph_non_ise_shm__null_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_duplicate__ff:
                group_by_columns: ["retailer_name", "sku_code", "osa_check_date", "branch_code"]
                count_column: ["filename", "retailer_name", "sku_code", "osa_check_date", "branch_code", "ret_nm_prefix"]
                where_condition: "ENCODED_REPORT = '1'"
                name: TRATBL_sdl_ph_non_ise_shm__duplicate_test
                config:
                  store_failures: true
                  schema: phlwks_integration   
          - test_lookup:
              select_columns: ["filename", "retailer_name", "sku_code", "osa_check_date", "branch_code", "ret_nm_prefix"]
              column: "UPPER(TRIM(RETAILER_NAME))"
              lookup_column: "UPPER(TRIM(RETAILER_NAME))"
              lookup_table: "dev_dna_core.snaposeitg_integration.ITG_PH_PS_RETAILER_SOLDTO_MAP "
              name: TRATBL_sdl_ph_non_ise_shm__lookup_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_date_format_odd_eve_leap:
              model_nm: "{{ source('phlsdl_raw', 'sdl_ph_non_ise_shm') }}"
              date_column: "osa_check_date"
              filter: "(odd_mon.osa_check_date) = (even_mon.osa_check_date) and (even_mon.osa_check_date) = (feb.osa_check_date) and (odd_mon.result) = (even_mon.result) and (even_mon.result) = (feb.result)"
              failure_reason: "'OSA CHECK DATE HAVING INCORRECT DATE-FORMAT. EXPECTED: MM/DD/YY'"
              select_columns: ["filename", "retailer_name", "sku_code", "osa_check_date", "branch_code", "ret_nm_prefix"]
              name: TRATBL_sdl_ph_non_ise_shm__test_date_format_odd_eve_leap
              config:
                store_failures: true
                schema: phlwks_integration
    - name: sdl_ph_non_ise_super_8
    - name: sdl_ph_non_ise_svi_smc
    - name: sdl_ph_non_ise_waltermart