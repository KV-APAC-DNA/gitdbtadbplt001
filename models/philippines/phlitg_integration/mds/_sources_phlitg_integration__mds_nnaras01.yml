version: 2

sources:
  - name: phlsdl_raw
    database: "{{ env_var('DBT_ENV_LOAD_DB') }}"
    schema: snaposesdl_raw
    quoting:
      database: false
      schema: false
      identifier: false
    tables:
    - name: sdl_mds_ph_npi_peg_item
      tags: ["ph_mds_itg_refresh","ingestion"]
      tests:
          - test_null:
              select_columns: ["peg_itemcode_code","peg_itemcode_name","code","salescycle"]
              not_null_columns: ["code"]
              name: TRATBL_sdl_mds_ph_npi_peg_item__null_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_duplicate:
              select_columns: ["peg_itemcode_code","peg_itemcode_name","code","salescycle"]
              group_by_columns: ["code"]
              name: TRATBL_sdl_mds_ph_npi_peg_item__duplicate_test
              config:
                store_failures: true
                schema: phlwks_integration
    - name: sdl_mds_ph_npi_sales_groupings
      tags: ["ph_mds_itg_refresh","ingestion"]
      tests:
          - test_null:
              select_columns: ["code","name"]
              not_null_columns: ["code"]
              name: TRATBL_sdl_mds_ph_npi_sales_groupings__null_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_duplicate:
              select_columns: ["code","name"]
              group_by_columns: ["code"]
              name: TRATBL_sdl_mds_ph_npi_sales_groupings__duplicate_test
              config:
                store_failures: true
                schema: phlwks_integration
    - name: sdl_mds_ph_targets_by_account_and_skus
      tags: ["ph_mds_itg_refresh","ingestion"]
      tests:
          - test_null:
              select_columns: ["account_code","sku_code","year","activity","area"]
              not_null_columns: ["account_code","sku_code","year"]
              name: TRATBL_sdl_mds_ph_targets_by_account_and_skus__null_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_duplicate:
              select_columns: ["account_code","sku_code","year","activity","area"]
              group_by_columns: ["account_code","sku_code","year"]
              name: TRATBL_sdl_mds_ph_targets_by_account_and_skus__duplicate_test
              config:
                store_failures: true
                schema: phlwks_integration
    - name: sdl_mds_ph_distributor_product
      tags: ["ph_mds_itg_refresh","ingestion"]
      tests:
          - test_null:
              select_columns: ["itemcode","distcode_code","name"]
              not_null_columns: ["itemcode","distcode_code"]
              name: TRATBL_sdl_mds_ph_distributor_product__null_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_duplicate:
              select_columns: ["itemcode","distcode_code","name"]
              group_by_columns: ["itemcode","distcode_code"]
              name: TRATBL_sdl_mds_ph_distributor_product__duplicate_test
              config:
                store_failures: true
                schema: phlwks_integration

    - name: sdl_mds_ph_ref_repfranchise
      tags: ["ph_mds_itg_refresh","ingestion"]
      tests:
          - test_null:
              select_columns: ["code","name"]
              not_null_columns: ["code"]
              name: TRATBL_sdl_mds_ph_ref_repfranchise__null_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_duplicate:
              select_columns: ["code","name"]
              group_by_columns: ["code"]
              name: TRATBL_sdl_mds_ph_ref_repfranchise__duplicate_test
              config:
                store_failures: true
                schema: phlwks_integration
    - name: sdl_mds_ph_lav_customer 
      tags: ["ph_mds_itg_refresh","ingestion"]
      tests:
          - test_null:
              select_columns: ["code","name"]
              not_null_columns: ["code"]
              name: TRATBL_sdl_mds_ph_lav_customer__null_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_duplicate:
              select_columns: ["code","name"]
              group_by_columns: ["code"]
              name: TRATBL_sdl_mds_ph_lav_customer__duplicate_test
              config:
                store_failures: true
                schema: phlwks_integration
    - name: sdl_mds_ph_pos_pricelist
      tags: ["ph_mds_itg_refresh","ingestion"]
      tests:
          - test_null:
              select_columns: ["product_code_code","yearmo","code","name"]
              not_null_columns: ["product_code_code","yearmo"]
              name: TRATBL_sdl_mds_ph_pos_pricelist__null_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_duplicate:
              select_columns: ["product_code_code","yearmo","code","name"]
              group_by_columns: ["product_code_code","yearmo"]
              name: TRATBL_sdl_mds_ph_pos_pricelist__duplicate_test
              config:
                store_failures: true
                schema: phlwks_integration
    - name: sdl_ph_iop_trgt
      tags: ["ph_iop_target","ingestion"]
      tests:
          - test_null:
              select_columns: ["measure","target_type","year","brand","segment","customer_code","account","filename"]
              not_null_columns: ["year","brand","customer_code"]
              name: TRATBL_sdl_ph_iop_trgt__null_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_duplicate:
              select_columns: ["measure","target_type","year","brand","segment","customer_code","account","filename"]
              group_by_columns: ["measure","target_type","year","brand","segment","customer_code","account","filename"]
              name: TRATBL_sdl_ph_iop_trgt__duplicate_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_format:
              select_columns: ["measure","target_type","year","brand","segment","customer_code","account","filename"]
              where_clause: "not regexp_like (trim(year),'[0-2][0-9][0-9][0-9][0-1][0-9]') and (trim(year) != '' and trim(year) is not null)"
              failure_reason: "'Invalid Format for From_salescycle :Expect format is YYYYMM'"
              name: TRATBL_sdl_ph_iop_trgt__format_test
              config:
                store_failures: true
                schema: phlwks_integration
          - test_lookup:
            select_columns: ["measure","target_type","year","brand","segment","customer_code","account","filename"]
            column: "upper(trim(brand))"
            lookup_column: "upper(trim(brand))"
            lookup_table: "{{source('phlsdl_raw','sdl_ph_iop_trgt')}} "
            lookup_filter: "upper(brand) in (SELECT upper(gph_prod_brnd) FROM {{ref{'phledw_integration__edw_vw_ph_material_dim'}}})"
            name: TRATBL_sdl_ph_iop_trgt_lookup_test_brand
            config:
              store_failures: true
              schema: phlwks_integration
          - test_lookup:
            select_columns: ["measure","target_type","year","brand","segment","customer_code","account","filename"]
            column: "upper(trim(segment))"
            lookup_column: "upper(trim(segment))"
            lookup_table: "{{source('phlsdl_raw','sdl_ph_iop_trgt')}} "
            lookup_filter: "upper(segment) in (SELECT upper(gph_prod_sgmnt) FROM {{ref{'phledw_integration__edw_vw_ph_material_dim'}}})"
            name: TRATBL_sdl_ph_iop_trgt_lookup_test_segment
            config:
              store_failures: true
              schema: phlwks_integration
          - test_lookup:
            select_columns: ["measure","target_type","year","brand","segment","customer_code","account","filename"]
            column: "upper(trim(customer_code))"
            lookup_column: "upper(cust_id))"
            lookup_table: "{{ref{'phledw_integration__edw_vw_ph_material_dim'}}}"
            name: TRATBL_sdl_ph_iop_trgt_lookup_test_customer_code
            config:
              store_failures: true
              schema: phlwks_integration
              